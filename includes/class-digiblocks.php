<?php
/**
 * DigiBlocks Plugin
 */

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * DigiBlocks main class.
 *
 * @package DigiBlocks
 */
class DigiBlocks {
	/**
	 * Instance of the plugin.
	 *
	 * @var DigiBlocks
	 */
	private static $instance;

	/**
	 * Plugin name.
	 *
	 * @var string
	 */
	private $plugin_name = 'digiblocks';

	/**
	 * Active blocks.
	 *
	 * @var array
	 */
	private $active_blocks = array();

	/**
	 * Creates or returns an instance of this class.
	 */
	public static function get_instance() {
		if ( is_null( self::$instance ) ) {
			self::$instance = new self();
		}
		return self::$instance;
	}

	/**
	 * Class constructor.
	 */
	private function __construct() {
		// Get blocks data.
		require_once DIGIBLOCKS_PLUGIN_DIR . 'includes/class-digiblocks-blocks-data.php';

		// Register blocks with server-side rendering.
		require_once DIGIBLOCKS_PLUGIN_DIR . 'includes/class-digiblocks-register-blocks.php';

		// Review notice
		require_once DIGIBLOCKS_PLUGIN_DIR . 'includes/class-digiblocks-review-notice.php';

		// Initialize schema markup
		require_once DIGIBLOCKS_PLUGIN_DIR . 'includes/class-digiblocks-schema-markup.php';

		// Plugin/theme install and activation handlers.
		require_once DIGIBLOCKS_PLUGIN_DIR . 'includes/class-digiblocks-install.php';

		// Activation hook.
		register_activation_hook( DIGIBLOCKS_PLUGIN_FILE, array( $this, 'plugin_activation' ) );

		// Register block category.
		add_filter( 'block_categories_all', array( $this, 'register_block_category' ), 9999999, 2 );

		// Register custom REST API routes.
		add_action( 'rest_api_init', array( $this, 'register_rest_routes' ) );

		// Enqueue assets.
		add_action( 'enqueue_block_editor_assets', array( $this, 'enqueue_editor_assets' ) );

		// Enqueue admin scripts.
		add_action( 'admin_enqueue_scripts', array( $this, 'enqueue_admin_scripts' ) );

		// Add admin menu.
		add_action( 'admin_menu', array( $this, 'add_admin_menu' ) );

		// Setup file generation hooks.
		add_action( 'save_post', array( $this, 'generate_block_assets' ), 10, 3 );

		// Enqueue block assets on frontend
		add_action( 'wp_enqueue_scripts', array( $this, 'enqueue_block_assets' ) );

		// Clean up assets when post is permanently deleted
		add_action( 'deleted_post', array( $this, 'cleanup_block_assets' ) );

		// Initialize fonts manager
		$this->init_fonts_manager();

		// Initialize forms handler if needed
		add_action( 'init', array( $this, 'init_forms_handler' ) );

		// Initialize newsletter handler if needed
		add_action( 'init', array( $this, 'init_newsletter_handler' ) );

		// Initialize search form handler if needed
		add_action( 'init', array( $this, 'init_search_handler' ) );

		// AJAX handlers for DigiCommerce Cart Icon block
		add_action( 'wp_ajax_digiblocks_get_digi_cart_data', array( $this, 'ajax_get_digi_cart_data' ) );
		add_action( 'wp_ajax_nopriv_digiblocks_get_digi_cart_data', array( $this, 'ajax_get_digi_cart_data' ) );

		add_action( 'wp_ajax_digiblocks_get_digi_cart_items', array( $this, 'ajax_get_digi_cart_items' ) );
		add_action( 'wp_ajax_nopriv_digiblocks_get_digi_cart_items', array( $this, 'ajax_get_digi_cart_items' ) );

		// AJAX handlers for Woo Cart Icon block
		add_action( 'wp_ajax_digiblocks_get_cart_data', array( $this, 'ajax_get_cart_data' ) );
		add_action( 'wp_ajax_nopriv_digiblocks_get_cart_data', array( $this, 'ajax_get_cart_data' ) );
		
		add_action( 'wp_ajax_digiblocks_get_cart_items', array( $this, 'ajax_get_cart_items' ) );
		add_action( 'wp_ajax_nopriv_digiblocks_get_cart_items', array( $this, 'ajax_get_cart_items' ) );
		
		add_action( 'wp_ajax_digiblocks_update_cart_item', array( $this, 'ajax_update_cart_item' ) );
		add_action( 'wp_ajax_nopriv_digiblocks_update_cart_item', array( $this, 'ajax_update_cart_item' ) );
		
		add_action( 'wp_ajax_digiblocks_remove_cart_item', array( $this, 'ajax_remove_cart_item' ) );
		add_action( 'wp_ajax_nopriv_digiblocks_remove_cart_item', array( $this, 'ajax_remove_cart_item' ) );

		// AJAX handler for Woo Add To Cart button
		add_action( 'wp_ajax_digiblocks_add_to_cart', array( $this, 'ajax_add_to_cart' ) );
		add_action( 'wp_ajax_nopriv_digiblocks_add_to_cart', array( $this, 'ajax_add_to_cart' ) );

		// AJAX handlers for DigiCommerce Add To Cart button
		add_action( 'wp_ajax_digiblocks_digi_add_to_cart', array( $this, 'ajax_digi_add_to_cart' ) );
		add_action( 'wp_ajax_nopriv_digiblocks_digi_add_to_cart', array( $this, 'ajax_digi_add_to_cart' ) );
	}

	/**
     * Initialize the fonts manager.
     */
    private function init_fonts_manager() {
        // Include the DigiBlocks_Fonts class
        require_once DIGIBLOCKS_PLUGIN_DIR . 'includes/class-digiblocks-fonts.php';
		$fonts_handler = DigiBlocks_Fonts::get_instance();
		$fonts_handler->init();
    }

	/**
	 * Plugin activation.
	 */
	public function plugin_activation() {
		// Create the digiblocks folder in wp-content/uploads if it doesn't exist.
		if ( ! file_exists( DIGIBLOCKS_ASSETS_DIR ) ) {
			wp_mkdir_p( DIGIBLOCKS_ASSETS_DIR );
		}

		// Create default plugin settings.
		$default_settings = array(
			'content_width'        => '1200',
			'content_max_width'    => '90',
			'recaptcha_site_key'   => '',
			'recaptcha_secret_key' => '',
			'google_maps_api_key'  => '',
			'google_maps_map_id'   => '',
			'google_fonts_local'   => false,
			'enable_schema_markup' => true,
		);

		// By default, no blocks are inactive
		$inactive_blocks = array();
    
		add_option( 'digiblocks_settings', $default_settings );
		add_option( 'digiblocks_inactive_blocks', $inactive_blocks );

		// Set transient to redirect to the dashboard on activation.
		set_transient( 'digiblocks_activation_redirect', true, 30 );
	}

	/**
	 * Register block category.
	 *
	 * @param array   $categories Block categories.
	 * @param WP_Post $post Current post object.
	 * @return array Modified block categories.
	 */
	public function register_block_category( $categories, $post ) { // phpcs:ignore
		$new_categories = array(
			array(
				'slug'  => 'digiblocks',
				'title' => esc_html__( 'DigiBlocks', 'digiblocks' ),
				'icon'  => $this->get_category_icon(),
			),
		);

		// Add DigiCommerce category if DigiCommerce exists
		if ( class_exists( 'DigiCommerce' ) ) {
			$new_categories[] = array(
				'slug'  => 'digiblocks-digicommerce',
				'title' => esc_html__( 'DigiBlocks DigiCommerce', 'digiblocks' ),
				'icon'  => $this->get_category_icon(),
			);
		}

		// Add WooCommerce category if WooCommerce exists
		if ( class_exists( 'WooCommerce' ) ) {
			$new_categories[] = array(
				'slug'  => 'digiblocks-woocommerce',
				'title' => esc_html__( 'DigiBlocks WooCommerce', 'digiblocks' ),
				'icon'  => $this->get_category_icon(),
			);
		}

		// Add theme category
		$new_categories[] = array(
			'slug'  => 'digiblocks-theme',
			'title' => esc_html__( 'DigiBlocks Theme', 'digiblocks' ),
			'icon'  => $this->get_category_icon(),
		);

		return array_merge( $new_categories, $categories );
	}

	/**
	 * Get category icon.
	 *
	 * @return string SVG icon.
	 */
	private function get_category_icon() {
		return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" fill="currentColor"/></svg>';
	}

	/**
	 * Get list of all blocks available in the plugin.
	 *
	 * @return array List of blocks.
	 */
	public function get_blocks_list() {
		$blocks      = array();
		$blocks_data = DigiBlocks_Blocks_Data::get_block_data();

		// Convert blocks data to the format expected by the dashboard
		foreach ($blocks_data as $block_name => $block_data) {
			// Generate SVG icon
			$icon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ' . $block_data['icon']['viewbox'] . '"><path d="' . $block_data['icon']['path'] . '"/></svg>';

			$blocks[] = array(
				'name'        => $block_name,
				'title'       => $block_data['title'],
				'description' => $block_data['description'],
				'icon'        => $icon,
			);
		}

		return $blocks;
	}

	/**
	 * Get plugin logo.
	 *
	 * @return string SVG icon.
	 */
	private function get_plugin_logo() {
		return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1764 350" width="200" height="40"><g><path d="M425.6331,249.9932V108.5933h69.6904c15.7559,0,29.624,2.8628,41.6123,8.585,11.9844,5.7256,21.3418,13.8369,28.0771,24.3408,6.7324,10.5039,10.1006,23.0283,10.1006,37.5728,0,14.6797-3.3682,27.3047-10.1006,37.875-6.7354,10.5732-16.0928,18.7197-28.0771,24.4414-11.9883,5.7256-25.8564,8.585-41.6123,8.585h-69.6904ZM473.305,212.8252h19.998c6.7324,0,12.625-1.2783,17.6758-3.8379,5.0498-2.5566,8.9883-6.3633,11.8164-11.4131s4.2422-11.2109,4.2422-18.4824c0-7.1367-1.4141-13.1968-4.2422-18.1807-2.8281-4.9805-6.7666-8.7524-11.8164-11.312-5.0508-2.5566-10.9434-3.8379-17.6758-3.8379h-19.998v67.064Z" fill="#16204c"/><path d="M592.4827,249.9932V108.5933h47.6719v141.3999h-47.6719Z" fill="#16204c"/><path d="M736.5071,253.2256c-11.4473,0-21.9863-1.7861-31.6133-5.3535-9.6289-3.5664-17.9775-8.6514-25.0479-15.251-7.0693-6.5967-12.5586-14.4082-16.4629-23.4316-3.9072-9.0205-5.8574-18.9883-5.8574-29.8965s1.9502-20.8721,5.8574-29.896c3.9043-9.0205,9.4248-16.832,16.5645-23.4316,7.1357-6.5967,15.585-11.6816,25.3506-15.251,9.7627-3.5669,20.5029-5.353,32.2188-5.353,14.0049,0,26.4941,2.3574,37.4717,7.0698,10.9736,4.7153,20.0293,11.4478,27.1689,20.2002l-30.502,26.8657c-4.4443-5.1162-9.2607-8.9888-14.4434-11.6147-5.1855-2.626-10.9424-3.939-17.2705-3.939-5.252,0-9.999.8076-14.2412,2.4238s-7.8467,3.9736-10.8076,7.0698c-2.9629,3.0996-5.252,6.8018-6.8672,11.1104-1.6162,4.311-2.4248,9.2256-2.4248,14.7456,0,5.252.8086,10.0693,2.4248,14.4434,1.6152,4.3779,3.9043,8.1152,6.8672,11.2109,2.9609,3.0996,6.4961,5.4893,10.6055,7.1709,4.1064,1.6855,8.7178,2.5254,13.8369,2.5254,5.3848,0,10.6367-.9092,15.7559-2.7275,5.1162-1.8174,10.5703-4.9482,16.3623-9.3926l26.6641,32.7236c-8.6201,5.792-18.4512,10.2363-29.4922,13.332-11.0439,3.0967-21.75,4.6465-32.1182,4.6465ZM756.7073,229.1875v-53.7324h41.4102v59.792l-41.4102-6.0596Z" fill="#16204c"/><path d="M818.5188,249.9932V108.5933h47.6719v141.3999h-47.6719Z" fill="#16204c"/><path d="M889.2161,249.9932V108.5933h75.5479c19.5254,0,33.9365,3.4688,43.2285,10.4028,9.292,6.9375,13.9375,15.791,13.9375,26.563,0,7.1396-1.9883,13.5024-5.959,19.0889-3.9736,5.5898-9.7305,9.999-17.2705,13.2319-7.5439,3.2314-16.8359,4.8477-27.876,4.8477l4.04-10.9082c11.04,0,20.5693,1.5493,28.583,4.6465,8.0107,3.0986,14.2061,7.5742,18.584,13.4326,4.374,5.8584,6.5645,12.8965,6.5645,21.1094,0,12.2549-5.084,21.8154-15.251,28.6836-10.1689,6.8682-25.0156,10.3018-44.541,10.3018h-79.5879ZM936.0803,216.6631h28.6836c5.2529,0,9.1914-.9404,11.8174-2.8281,2.626-1.8838,3.9395-4.6455,3.9395-8.2812s-1.3135-6.3945-3.9395-8.2822c-2.626-1.8848-6.5645-2.8281-11.8174-2.8281h-31.915v-31.5122h25.4512c5.3848,0,9.3242-.9092,11.8174-2.7271,2.4902-1.8179,3.7373-4.4092,3.7373-7.7769,0-3.5005-1.2471-6.1265-3.7373-7.8779-2.4932-1.7485-6.4326-2.626-11.8174-2.626h-22.2197v74.7397Z" fill="#16204c"/><path d="M1045.3616,249.9932V108.5933h47.6719v104.4341h63.832v36.9658h-111.5039Z" fill="#16204c"/><path d="M1242.3098,253.2256c-11.583,0-22.2539-1.8184-32.0166-5.4541-9.7656-3.6357-18.2148-8.7871-25.3506-15.4531-7.1396-6.666-12.6953-14.5088-16.665-23.5332-3.9736-9.0205-5.959-18.8516-5.959-29.4922,0-10.772,1.9854-20.6353,5.959-29.5928,3.9697-8.9541,9.5254-16.7661,16.665-23.4321,7.1357-6.666,15.585-11.8169,25.3506-15.4531,9.7627-3.6357,20.3672-5.4536,31.8154-5.4536,11.5801,0,22.2197,1.8179,31.916,5.4536,9.6953,3.6362,18.1104,8.7871,25.25,15.4531,7.1357,6.666,12.6904,14.478,16.6641,23.4321,3.9707,8.9575,5.96,18.8208,5.96,29.5928,0,10.6406-1.9893,20.4717-5.96,29.4922-3.9736,9.0244-9.5283,16.8672-16.6641,23.5332-7.1396,6.666-15.5547,11.8174-25.25,15.4531-9.6963,3.6357-20.2695,5.4541-31.7148,5.4541ZM1242.1087,214.6436c4.4434,0,8.585-.8086,12.4229-2.4238,3.8379-1.6162,7.2021-3.9395,10.0996-6.9697,2.8945-3.0293,5.1514-6.7314,6.7676-11.1094,1.6152-4.375,2.4238-9.3242,2.4238-14.8477,0-5.52-.8086-10.4692-2.4238-14.8467-1.6162-4.3745-3.873-8.0801-6.7676-11.1104-2.8975-3.0298-6.2617-5.3525-10.0996-6.9688s-7.9795-2.4238-12.4229-2.4238-8.585.8076-12.4238,2.4238c-3.8379,1.6162-7.2051,3.939-10.0996,6.9688-2.8975,3.0303-5.1514,6.7358-6.7666,11.1104-1.6162,4.3774-2.4248,9.3267-2.4248,14.8467,0,5.5234.8086,10.4727,2.4248,14.8477,1.6152,4.3779,3.8691,8.0801,6.7666,11.1094,2.8945,3.0303,6.2617,5.3535,10.0996,6.9697,3.8389,1.6152,7.9795,2.4238,12.4238,2.4238Z" fill="#16204c"/><path d="M1412.3928,253.2256c-11.3115,0-21.7842-1.7861-31.4111-5.3535-9.6289-3.5664-17.9775-8.6514-25.0479-15.251-7.0693-6.5967-12.5586-14.4082-16.4629-23.4316-3.9072-9.0205-5.8574-18.9883-5.8574-29.8965s1.9502-20.8721,5.8574-29.896c3.9043-9.0205,9.3936-16.832,16.4629-23.4316,7.0703-6.5967,15.4189-11.6816,25.0479-15.251,9.627-3.5669,20.0996-5.353,31.4111-5.353,13.8691,0,26.1592,2.4238,36.8652,7.272,10.7061,4.8477,19.5596,11.8516,26.5635,21.0078l-30.0986,26.8662c-4.1758-5.252-8.7871-9.3237-13.8369-12.2212-5.0498-2.894-10.7402-4.3428-17.0693-4.3428-4.9834,0-9.4932.8076-13.5332,2.4238s-7.5088,3.9736-10.4033,7.0698c-2.8975,3.0996-5.1514,6.8364-6.7666,11.2109-1.6162,4.3779-2.4248,9.2607-2.4248,14.645,0,5.3877.8086,10.2705,2.4248,14.6455,1.6152,4.3779,3.8691,8.1143,6.7666,11.2109,2.8945,3.0996,6.3633,5.4541,10.4033,7.0703,4.04,1.6152,8.5498,2.4238,13.5332,2.4238,6.3291,0,12.0195-1.4453,17.0693-4.3428,5.0498-2.8945,9.6611-6.9697,13.8369-12.2217l30.0986,26.8662c-7.0039,9.0234-15.8574,15.9932-26.5635,20.9072s-22.9961,7.373-36.8652,7.373Z" fill="#16204c"/><path d="M1489.554,249.9932V108.5933h46.8643v141.3999h-46.8643ZM1532.176,219.6934l-2.626-52.3184,53.3281-58.7817h51.9141l-59.792,65.8521-26.4619,27.0684-16.3623,18.1797ZM1582.4739,249.9932l-41.6113-54.9434,30.9053-32.7246,65.8525,87.668h-55.1465Z" fill="#16204c"/><path d="M1693.7766,253.2256c-11.8516,0-23.2998-1.3477-34.3398-4.04-11.0439-2.6924-20.1338-6.1924-27.2705-10.5039l15.3516-34.7441c6.7324,3.9072,14.2412,7.0381,22.5234,9.3926,8.2822,2.3584,16.3271,3.5352,24.1387,3.5352,4.5771,0,8.1816-.3027,10.8076-.9092,2.626-.6055,4.5449-1.4795,5.7568-2.626,1.2119-1.1426,1.8184-2.5244,1.8184-4.1406,0-2.5566-1.4141-4.5762-4.2422-6.0596-2.8281-1.4805-6.5654-2.7275-11.2109-3.7373-4.6465-1.0098-9.7314-2.0869-15.251-3.2324-5.5234-1.1426-11.0791-2.6572-16.665-4.5449-5.5898-1.8838-10.7061-4.374-15.3525-7.4736-4.6455-3.0967-8.3828-7.1709-11.2109-12.2217-2.8281-5.0498-4.2422-11.3433-4.2422-18.8867,0-8.7524,2.4561-16.7314,7.373-23.937,4.915-7.2026,12.2529-12.9595,22.0186-17.271,9.7617-4.3081,21.917-6.4639,36.4609-6.4639,9.5605,0,18.9883,1.0098,28.2803,3.0298s17.6396,5.1196,25.0479,9.292l-14.3428,34.542c-7.0029-3.5-13.7705-6.1265-20.3008-7.8779-6.5332-1.7485-12.8965-2.626-19.0889-2.626-4.5801,0-8.2158.4038-10.9082,1.2119-2.6953.8081-4.6143,1.8877-5.7568,3.2319-1.1455,1.3477-1.7168,2.8281-1.7168,4.4443,0,2.4238,1.4141,4.3428,4.2422,5.7568s6.5645,2.5942,11.2109,3.5352c4.6455.9434,9.7617,1.9536,15.3516,3.0298,5.5869,1.0796,11.1416,2.5596,16.665,4.4438,5.5205,1.8877,10.6055,4.3779,15.251,7.4741,4.6465,3.1001,8.3828,7.1401,11.2109,12.1206,2.8281,4.9834,4.2422,11.1787,4.2422,18.584,0,8.6191-2.459,16.5322-7.373,23.7344-4.917,7.2061-12.2207,12.998-21.917,17.3721-9.6963,4.375-21.8857,6.5654-36.5615,6.5654Z" fill="#16204c"/></g><g><circle cx="174.9319" cy="175" r="175" fill="#526bfe"/><g><path d="M176.5325,87.2646l-37.3028,20.1121c16.9844,9.3171,8.0137,4.3968,37.3001,20.4585l37.3054-20.4585-37.3028-20.1121Z" fill="#fff"/><path d="M135.1554,156.9631l-37.3028,20.1095c16.5799,9.0977,7.9343,4.3545,37.3001,20.4585l37.1732-20.3871c-11.9636-6.6336-4.5026-2.5699-37.1706-20.1809Z" fill="#fff"/><path d="M137.0908,243.6539l37.4931-20.7837v-42.5271l-37.4931,20.5616v42.7492Z" fill="#fff"/><path d="M217.9016,156.9631c-32.7976,17.6797-25.4396,13.6769-37.1732,20.1809,14.7768,8.1088,7.1015,3.8997,37.1706,20.3898l37.3054-20.4585-37.3028-20.1122Z" fill="#fff"/><path d="M215.9583,153.1718v-42.5271l-37.4931,20.5616v42.6012c12.2465-6.5992,4.7352-2.4773,37.4931-20.6356Z" fill="#fff"/><path d="M178.4757,180.3431v42.5271l37.4746,20.7837v-42.7519c-31.7664-17.4286-24.0119-13.1745-37.4746-20.559Z" fill="#fff"/><path d="M174.5813,173.8021v-42.5985c-30.2489-16.5958-22.5022-12.347-37.4746-20.559v42.5271c32.5015,18.0261,24.9637,13.8858,37.4746,20.6303Z" fill="#fff"/><path d="M219.8342,243.6539l37.4931-20.7837v-42.5271l-37.4931,20.5616v42.7492Z" fill="#fff"/><path d="M95.7296,180.3431v42.5271l37.4746,20.7837v-42.7519c-29.9792-16.4503-22.2246-12.1937-37.4746-20.559Z" fill="#fff"/></g></g></svg>';
	}

	/**
	 * Get promotional content for admin sidebar.
	 *
	 * @return string HTML content.
	 */
	public function get_promo_content() {
		ob_start();
		$install = DigiBlocks_Install::get_instance();
		?>
		<!-- DigiCommerce Promo -->
		<div class="digiblocks-admin-section digiblocks-promo-section">
			<div class="digiblocks-section-header">
				<h2><?php esc_html_e( 'Grow Your Business', 'digiblocks' ); ?></h2>
			</div>

			<div class="digiblocks-promo-container">
				<div class="digiblocks-promo-product">
					<div class="digiblocks-promo-logo">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2148.09 350" width="200" height="33"><g><path d="M425.4756,249.9932V108.5933h69.6904c15.7559,0,29.624,2.8628,41.6123,8.585,11.9844,5.7256,21.3418,13.8369,28.0771,24.3408,6.7324,10.5039,10.1006,23.0283,10.1006,37.5718,0,14.6797-3.3682,27.3047-10.1006,37.875-6.7354,10.5732-16.0928,18.7197-28.0771,24.4424-11.9883,5.7256-25.8564,8.585-41.6123,8.585h-69.6904ZM473.1475,212.8252h19.998c6.7324,0,12.625-1.2783,17.6758-3.8379,5.0498-2.5566,8.9883-6.3633,11.8164-11.4131,2.8281-5.0508,4.2422-11.2109,4.2422-18.4834,0-7.1357-1.4141-13.1958-4.2422-18.1797-2.8281-4.9805-6.7666-8.7524-11.8164-11.312-5.0508-2.5566-10.9434-3.8379-17.6758-3.8379h-19.998v67.064Z" fill="#09053a"/><path d="M592.3252,249.9932V108.5933h47.6719v141.3999h-47.6719Z" fill="#09053a"/><path d="M736.3496,253.2246c-11.4473,0-21.9863-1.7861-31.6133-5.3525-9.6289-3.5664-17.9775-8.6514-25.0479-15.251-7.0693-6.5967-12.5586-14.4082-16.4629-23.4326-3.9072-9.0205-5.8574-18.9873-5.8574-29.8955s1.9502-20.8721,5.8574-29.896c3.9043-9.0205,9.4248-16.832,16.5645-23.4316,7.1357-6.5967,15.585-11.6816,25.3506-15.251,9.7627-3.5669,20.5029-5.353,32.2188-5.353,14.0049,0,26.4941,2.3574,37.4717,7.0698,10.9736,4.7153,20.0293,11.4478,27.1689,20.2002l-30.502,26.8657c-4.4443-5.1162-9.2607-8.9888-14.4434-11.6147-5.1855-2.626-10.9424-3.939-17.2705-3.939-5.252,0-9.999.8076-14.2412,2.4238s-7.8467,3.9736-10.8076,7.0698c-2.9629,3.0996-5.252,6.8018-6.8672,11.1104-1.6162,4.311-2.4248,9.2256-2.4248,14.7456,0,5.252.8086,10.0684,2.4248,14.4434,1.6152,4.377,3.9043,8.1143,6.8672,11.2109,2.9609,3.0986,6.4961,5.4883,10.6055,7.1709,4.1064,1.6855,8.7178,2.5244,13.8369,2.5244,5.3848,0,10.6367-.9082,15.7559-2.7266,5.1162-1.8184,10.5703-4.9492,16.3623-9.3936l26.6641,32.7246c-8.6201,5.792-18.4512,10.2354-29.4922,13.332-11.0439,3.0957-21.75,4.6455-32.1182,4.6455ZM756.5498,229.1865v-53.7314h41.4102v59.792l-41.4102-6.0605Z" fill="#09053a"/><path d="M818.3613,249.9932V108.5933h47.6719v141.3999h-47.6719Z" fill="#09053a"/><path d="M962.1826,253.2246c-11.3115,0-21.7842-1.7861-31.4111-5.3525-9.6289-3.5664-17.9775-8.6514-25.0479-15.251-7.0693-6.5967-12.5586-14.4082-16.4629-23.4326-3.9072-9.0205-5.8574-18.9873-5.8574-29.8955s1.9502-20.8721,5.8574-29.896c3.9043-9.0205,9.3936-16.832,16.4629-23.4316,7.0703-6.5967,15.4189-11.6816,25.0479-15.251,9.627-3.5669,20.0996-5.353,31.4111-5.353,13.8691,0,26.1592,2.4238,36.8652,7.272,10.7061,4.8477,19.5596,11.8516,26.5635,21.0078l-30.0986,26.8662c-4.1758-5.252-8.7871-9.3237-13.8369-12.2212-5.0498-2.894-10.7402-4.3428-17.0693-4.3428-4.9834,0-9.4932.8076-13.5332,2.4238s-7.5088,3.9736-10.4033,7.0698c-2.8975,3.0996-5.1514,6.8364-6.7666,11.2109-1.6162,4.3779-2.4248,9.2607-2.4248,14.645,0,5.3877.8086,10.2705,2.4248,14.6445,1.6152,4.3779,3.8691,8.1152,6.7666,11.2109,2.8945,3.0996,6.3633,5.4541,10.4033,7.0703s8.5498,2.4238,13.5332,2.4238c6.3291,0,12.0195-1.4453,17.0693-4.3428,5.0498-2.8945,9.6611-6.9688,13.8369-12.2207l30.0986,26.8662c-7.0039,9.0234-15.8574,15.9922-26.5635,20.9062-10.7061,4.915-22.9961,7.373-36.8652,7.373Z" fill="#09053a"/><path d="M1110.6504,253.2246c-11.583,0-22.2539-1.8174-32.0166-5.4541-9.7656-3.6357-18.2148-8.7861-25.3506-15.4521-7.1396-6.666-12.6953-14.5098-16.665-23.5332-3.9736-9.0205-5.959-18.8525-5.959-29.4922,0-10.772,1.9854-20.6353,5.959-29.5928,3.9697-8.9541,9.5254-16.7661,16.665-23.4321,7.1357-6.666,15.585-11.8169,25.3506-15.4531,9.7627-3.6357,20.3672-5.4536,31.8154-5.4536,11.5801,0,22.2197,1.8179,31.916,5.4536,9.6953,3.6362,18.1104,8.7871,25.25,15.4531,7.1357,6.666,12.6904,14.478,16.6641,23.4321,3.9707,8.9575,5.96,18.8208,5.96,29.5928,0,10.6396-1.9893,20.4717-5.96,29.4922-3.9736,9.0234-9.5283,16.8672-16.6641,23.5332-7.1396,6.666-15.5547,11.8164-25.25,15.4521-9.6963,3.6367-20.2695,5.4541-31.7148,5.4541ZM1110.4492,214.6426c4.4434,0,8.585-.8076,12.4229-2.4238s7.2021-3.9385,10.0996-6.9688c2.8945-3.0303,5.1514-6.7324,6.7676-11.1104,1.6152-4.374,2.4238-9.3232,2.4238-14.8467,0-5.52-.8086-10.4692-2.4238-14.8467-1.6162-4.3745-3.873-8.0801-6.7676-11.1104-2.8975-3.0298-6.2617-5.3525-10.0996-6.9688s-7.9795-2.4238-12.4229-2.4238-8.585.8076-12.4238,2.4238c-3.8379,1.6162-7.2051,3.939-10.0996,6.9688-2.8975,3.0303-5.1514,6.7358-6.7666,11.1104-1.6162,4.3774-2.4248,9.3267-2.4248,14.8467,0,5.5234.8086,10.4727,2.4248,14.8467,1.6152,4.3779,3.8691,8.0801,6.7666,11.1104,2.8945,3.0303,6.2617,5.3525,10.0996,6.9688,3.8389,1.6162,7.9795,2.4238,12.4238,2.4238Z" fill="#09053a"/><path d="M1207.6094,249.9932V108.5933h39.1885l56.5596,92.314h-20.6035l54.9434-92.314h39.1885l.4043,141.3999h-43.4307l-.4033-75.9521h6.8672l-37.5713,63.2256h-21.0078l-39.1885-63.2256h8.4844v75.9521h-43.4307Z" fill="#09053a"/><path d="M1400.3164,249.9932V108.5933h39.1885l56.5596,92.314h-20.6035l54.9434-92.314h39.1885l.4043,141.3999h-43.4307l-.4033-75.9521h6.8672l-37.5713,63.2256h-21.0078l-39.1885-63.2256h8.4844v75.9521h-43.4307Z" fill="#09053a"/><path d="M1639.8877,214.0371h70.7002v35.9561h-117.5645V108.5933h114.9385v35.9561h-68.0742v69.4878ZM1636.6562,161.1133h63.0234v34.3398h-63.0234v-34.3398Z" fill="#09053a"/><path d="M1728.9668,249.9932V108.5933h68.0742c13.1963,0,24.6094,2.1558,34.2393,6.4639,9.626,4.3115,17.0693,10.4727,22.3213,18.4829,5.252,8.0137,7.8779,17.4731,7.8779,28.3813s-2.626,20.3003-7.8779,28.1782-12.6953,13.9072-22.3213,18.0791c-9.6299,4.1758-21.043,6.2627-34.2393,6.2627h-41.6123l21.21-19.5947v55.1465h-47.6719ZM1776.6387,200.0986l-21.21-21.6133h38.582c6.5967,0,11.4795-1.4805,14.6455-4.4443,3.1621-2.9604,4.7471-7.0005,4.7471-12.1196s-1.585-9.1567-4.7471-12.1201c-3.166-2.9604-8.0488-4.4443-14.6455-4.4443h-38.582l21.21-21.6138v76.3555ZM1813.6055,249.9932l-34.7441-51.5098h50.5l35.1475,51.5098h-50.9033Z" fill="#09053a"/><path d="M1952.5801,253.2246c-11.3115,0-21.7842-1.7861-31.4111-5.3525-9.6289-3.5664-17.9775-8.6514-25.0479-15.251-7.0693-6.5967-12.5586-14.4082-16.4629-23.4326-3.9072-9.0205-5.8574-18.9873-5.8574-29.8955s1.9502-20.8721,5.8574-29.896c3.9043-9.0205,9.3936-16.832,16.4629-23.4316,7.0703-6.5967,15.4189-11.6816,25.0479-15.251,9.627-3.5669,20.0996-5.353,31.4111-5.353,13.8691,0,26.1592,2.4238,36.8652,7.272,10.7061,4.8477,19.5596,11.8516,26.5635,21.0078l-30.0986,26.8662c-4.1758-5.252-8.7871-9.3237-13.8369-12.2212-5.0498-2.894-10.7402-4.3428-17.0693-4.3428-4.9834,0-9.4932.8076-13.5332,2.4238s-7.5088,3.9736-10.4033,7.0698c-2.8975,3.0996-5.1514,6.8364-6.7666,11.2109-1.6162,4.3779-2.4248,9.2607-2.4248,14.645,0,5.3877.8086,10.2705,2.4248,14.6445,1.6152,4.3779,3.8691,8.1152,6.7666,11.2109,2.8945,3.0996,6.3633,5.4541,10.4033,7.0703s8.5498,2.4238,13.5332,2.4238c6.3291,0,12.0195-1.4453,17.0693-4.3428,5.0498-2.8945,9.6611-6.9688,13.8369-12.2207l30.0986,26.8662c-7.0039,9.0234-15.8574,15.9922-26.5635,20.9062-10.7061,4.915-22.9961,7.373-36.8652,7.373Z" fill="#09053a"/><path d="M2076.6055,214.0371h70.7002v35.9561h-117.5645V108.5933h114.9385v35.9561h-68.0742v69.4878ZM2073.374,161.1133h63.0234v34.3398h-63.0234v-34.3398Z" fill="#09053a"/></g><g><circle cx="175" cy="175" r="175" fill="#ccb161"/><path d="M349.8016,184.1762c-4.2758,82.7633-66.0552,150.3104-146.1534,163.4835l-81.4756-81.4756c-.3885-.3363-.7648-.6865-1.128-1.05-3.8777-3.8755-6.2738-9.2269-6.2738-15.1382-.009-6.1388,2.6257-11.9842,7.2311-16.0431l-8.3358-8.3358c-.3449-.299-.6796-.6111-1.0026-.9341-3.4402-3.4402-5.5752-8.1907-5.5752-13.4225,0-1.6406.2107-3.2339.6052-4.7542l-32.7454-32.7454c-2.0957-1.7274-2.3942-4.8267-.6668-6.9224.9339-1.133,2.3252-1.7894,3.7935-1.7897h38.6684l-45.2032-45.2032c-1.9201-1.9218-1.9187-5.0363.0031-6.9565.9211-.9202,2.1694-1.4378,3.4714-1.4392h28.3828l-24.457-24.457c-.9239-.9211-1.4422-2.1728-1.4401-3.4774-.0008-2.7163,2.2005-4.9189,4.9168-4.9197h20.5931c1.3409,0,2.5565.5359,3.4439,1.4051l.0729.0729,31.3753,31.3753h137.1708c1.4694-.003,2.8623.6545,3.7939,1.7908l70.9348,70.9363Z" fill="#ab8b2b" fill-rule="evenodd"/><path d="M247.1094,238.4189c3.1996,0,6.0907,1.2987,8.1966,3.3906,2.169,2.1718,3.3851,5.117,3.3804,8.1863,0,3.1938-1.2928,6.0907-3.3804,8.1827-2.1739,2.173-5.1228,3.3921-8.1966,3.3884-3.071.0049-6.0172-1.2146-8.1863-3.3884-2.1725-2.1686-3.3918-5.1131-3.3884-8.1827,0-3.1996,1.2965-6.0907,3.3884-8.1863,2.1696-2.1734,5.1154-3.3934,8.1863-3.3906h0ZM136.1827,238.4189c3.1988,0,6.0944,1.2987,8.1864,3.3906,2.1748,2.1686,3.3949,5.1151,3.3899,8.1863,0,3.1938-1.2943,6.0907-3.3899,8.1827-2.1685,2.1749-5.1152,3.3945-8.1864,3.3884-3.07.0055-6.0153-1.2141-8.1827-3.3884-2.1743-2.1675-3.3944-5.1126-3.3899-8.1827,0-3.1996,1.2943-6.0907,3.3899-8.1863,2.1678-2.1739,5.1126-3.3942,8.1827-3.3906h0ZM99.125,88.4322l5.4826,23.0161h-29.5947c-2.7165,0-4.9186,2.2021-4.9186,4.9186s2.2021,4.9186,4.9186,4.9186h68.8866c2.7159,0,4.9175,2.2016,4.9175,4.9175s-2.2016,4.9175-4.9175,4.9175h-34.6048l1.664,6.9934h-6.1666c-2.7165,0-4.9186,2.2021-4.9186,4.9186s2.2021,4.9186,4.9186,4.9186h44.2138c2.7165.0331,4.8917,2.2621,4.8586,4.9786-.0325,2.6698-2.1889,4.8261-4.8586,4.8586h-33.3645l1.7281,7.2596h-39.2962c-2.7147,0-4.9153,2.2014-4.9153,4.9175s2.2014,4.9175,4.9153,4.9175h77.7416c2.7165.0329,4.892,2.2616,4.8591,4.9781-.0323,2.6701-2.189,4.8268-4.8591,4.8591h-33.756l1.8251,7.6694c-4.3524.5068-8.268,2.4974-11.2211,5.4461-3.4402,3.4438-5.5752,8.1944-5.5752,13.424s2.1357,9.9823,5.5752,13.4225c3.4439,3.4461,8.1944,5.5796,13.4283,5.5796h1.766c-2.5444,1.0783-4.8574,2.6365-6.8126,4.5894-4.0237,4.0117-6.2817,9.4622-6.2738,15.1441,0,5.9114,2.396,11.2627,6.2738,15.1382,3.8755,3.8755,9.2305,6.2716,15.1382,6.2716,5.9114,0,11.2685-2.396,15.1441-6.2716,3.8755-3.8755,6.2716-9.2269,6.2716-15.1382.0077-5.6814-2.2493-11.1316-6.2716-15.1441-1.9561-1.9529-4.2698-3.511-6.8148-4.5894h94.2674c-2.5432,1.0782-4.8547,2.6364-6.8082,4.5894-3.8755,3.8755-6.2738,9.2305-6.2738,15.1441s2.3982,11.2627,6.2738,15.1382c3.8755,3.8755,9.2261,6.2716,15.1382,6.2716s11.2583-2.396,15.136-6.2716c3.8777-3.8755,6.2832-9.2269,6.2832-15.1382s-2.4062-11.2685-6.2832-15.1441c-1.9491-1.9546-4.2584-3.5131-6.8002-4.5894h7.019c2.7045,0,4.9117-2.2014,4.9117-4.9197s-2.2072-4.9197-4.9117-4.9197H126.0911c-2.5156,0-4.8059-1.0318-6.4728-2.6921-1.6603-1.6647-2.6965-3.9514-2.6965-6.4706,0-2.5156,1.0361-4.8023,2.6965-6.4663,1.6661-1.6603,3.9572-2.6965,6.4728-2.6965h119.6781c3.9827,0,7.6716-1.3322,10.6101-3.6429,2.9232-2.3005,5.0903-5.5694,6.0448-9.4588l17.3199-71.0639c.1609-.5052.2413-1.0325.2384-1.5626,0-2.7162-2.1875-4.9197-4.9117-4.9197H114.7168l-6.8863-28.91c-.4643-2.2944-2.4811-3.9437-4.822-3.9433h-20.5902c-2.7163-.0008-4.9189,2.2005-4.9197,4.9168v.0029c0,2.7159,2.2016,4.9175,4.9175,4.9175h16.7089v-.0007Z" fill="#fff" fill-rule="evenodd"/></g></svg>
					</div>
					<div class="digiblocks-promo-content">
						<p><?php echo wp_kses_post( __( 'Transform your site into a conversion-optimized ecommerce designed specifically for selling <strong>digital products</strong>, <strong>booking services</strong>, and delivering <strong>online courses</strong>. Lightning-fast checkout, secure digital delivery, and professional payment processing built to maximize your revenue and scale your digital business.', 'digiblocks' ) ); ?></p>
						<div class="digiblocks-link-wrapper">
							<?php
							$digicommerce_status = $install->get_plugin_status( 'digicommerce' );
							$button_action = $digicommerce_status['status'] === 'active' ? 'learn_more' : ($digicommerce_status['status'] === 'inactive' ? 'activate' : 'install');
							?>
							<button type="button" 
								class="digiblocks-button digiblocks-plugin-action <?php echo esc_attr( $digicommerce_status['button_class'] ); ?>"
								data-plugin="digicommerce" 
								data-action="<?php echo esc_attr( $button_action ); ?>"
								data-type="plugin"
								<?php if ( $digicommerce_status['status'] === 'active' ) : ?>
								data-url="<?php echo esc_url( $digicommerce_status['url'] ); ?>"
								<?php endif; ?>>
								<span><?php echo esc_html( $digicommerce_status['button_text'] ); ?></span>
								<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="1em" height="1em"><path d="M505 273c9.4-9.4 9.4-24.6 0-33.9L369 103c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l95 95L24 232c-13.3 0-24 10.7-24 24s10.7 24 24 24l406.1 0-95 95c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0L505 273z"/></svg>
							</button>
						</div>
					</div>
				</div>

				<div class="digiblocks-promo-product">
					<div class="digiblocks-promo-logo">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1590 350" width="150" height="33"><g><path d="M425.8819,249.9932V108.5933h69.6904c15.7559,0,29.624,2.8628,41.6123,8.585,11.9844,5.7256,21.3418,13.8369,28.0771,24.3408,6.7324,10.5039,10.1006,23.0283,10.1006,37.5718,0,14.6797-3.3682,27.3047-10.1006,37.875-6.7354,10.5732-16.0928,18.7197-28.0771,24.4424-11.9883,5.7256-25.8564,8.585-41.6123,8.585h-69.6904ZM473.5537,212.8252h19.998c6.7324,0,12.625-1.2783,17.6758-3.8379,5.0498-2.5566,8.9883-6.3633,11.8164-11.4131,2.8281-5.0508,4.2422-11.2109,4.2422-18.4834,0-7.1357-1.4141-13.1958-4.2422-18.1797-2.8281-4.9805-6.7666-8.7524-11.8164-11.312-5.0508-2.5566-10.9434-3.8379-17.6758-3.8379h-19.998v67.064Z" fill="#2c3e50"/><path d="M592.7315,249.9932V108.5933h47.6719v141.3999h-47.6719Z" fill="#2c3e50"/><path d="M736.7559,253.2246c-11.4473,0-21.9863-1.7861-31.6133-5.3525-9.6289-3.5664-17.9775-8.6514-25.0479-15.251-7.0693-6.5967-12.5586-14.4082-16.4629-23.4326-3.9072-9.0205-5.8574-18.9873-5.8574-29.8955s1.9502-20.8721,5.8574-29.896c3.9043-9.0205,9.4248-16.832,16.5645-23.4316,7.1357-6.5967,15.585-11.6816,25.3506-15.251,9.7627-3.5669,20.5029-5.353,32.2188-5.353,14.0049,0,26.4941,2.3574,37.4717,7.0698,10.9736,4.7153,20.0293,11.4478,27.1689,20.2002l-30.502,26.8657c-4.4443-5.1162-9.2607-8.9888-14.4434-11.6147-5.1855-2.626-10.9424-3.939-17.2705-3.939-5.252,0-9.999.8076-14.2412,2.4238s-7.8467,3.9736-10.8076,7.0698c-2.9629,3.0996-5.252,6.8018-6.8672,11.1104-1.6162,4.311-2.4248,9.2256-2.4248,14.7456,0,5.252.8086,10.0684,2.4248,14.4434,1.6152,4.377,3.9043,8.1143,6.8672,11.2109,2.9609,3.0986,6.4961,5.4883,10.6055,7.1709,4.1064,1.6855,8.7178,2.5244,13.8369,2.5244,5.3848,0,10.6367-.9082,15.7559-2.7266,5.1162-1.8184,10.5703-4.9492,16.3623-9.3936l26.6641,32.7246c-8.6201,5.792-18.4512,10.2354-29.4922,13.332-11.0439,3.0957-21.75,4.6455-32.1182,4.6455ZM756.9561,229.1865v-53.7314h41.4102v59.792l-41.4102-6.0605Z" fill="#2c3e50"/><path d="M818.7676,249.9932V108.5933h47.6719v141.3999h-47.6719Z" fill="#2c3e50"/><path d="M942.1875,253.2246c-11.8516,0-23.2998-1.3477-34.3398-4.04-11.0439-2.6924-20.1338-6.1924-27.2705-10.5039l15.3516-34.7441c6.7324,3.9082,14.2412,7.0391,22.5234,9.3936,8.2822,2.3574,16.3271,3.5352,24.1387,3.5352,4.5771,0,8.1816-.3037,10.8076-.9092,2.626-.6064,4.5449-1.4805,5.7568-2.626,1.2119-1.1426,1.8184-2.5254,1.8184-4.1416,0-2.5557-1.4141-4.5762-4.2422-6.0596-2.8281-1.4805-6.5654-2.7266-11.2109-3.7373-4.6465-1.0098-9.7314-2.0859-15.251-3.2314-5.5234-1.1426-11.0791-2.6582-16.665-4.5449-5.5898-1.8848-10.7061-4.375-15.3525-7.4746-4.6455-3.0957-8.3828-7.1709-11.2109-12.2207s-4.2422-11.3433-4.2422-18.8867c0-8.7524,2.4561-16.7314,7.373-23.937,4.915-7.2026,12.2529-12.9595,22.0186-17.271,9.7617-4.3081,21.917-6.4639,36.4609-6.4639,9.5605,0,18.9883,1.0098,28.2803,3.0298s17.6396,5.1196,25.0479,9.292l-14.3428,34.542c-7.0029-3.5-13.7705-6.1265-20.3008-7.8779-6.5332-1.7485-12.8965-2.626-19.0889-2.626-4.5801,0-8.2158.4038-10.9082,1.2119-2.6953.8081-4.6143,1.8877-5.7568,3.2319-1.1455,1.3477-1.7168,2.8281-1.7168,4.4443,0,2.4238,1.4141,4.3428,4.2422,5.7568s6.5645,2.5942,11.2109,3.5352c4.6455.9434,9.7617,1.9536,15.3516,3.0298,5.5869,1.0796,11.1416,2.5596,16.665,4.4438,5.5205,1.8877,10.6055,4.3779,15.251,7.4741,4.6465,3.0991,8.3828,7.1392,11.2109,12.1196,2.8281,4.9844,4.2422,11.1797,4.2422,18.584,0,8.6201-2.459,16.5322-7.373,23.7354-4.917,7.2051-12.2207,12.9971-21.917,17.3721-9.6963,4.374-21.8857,6.5645-36.5615,6.5645Z" fill="#2c3e50"/><path d="M1050.8643,249.9932v-104.4341h-41.4102v-36.9658h130.4922v36.9658h-41.4102v104.4341h-47.6719Z" fill="#2c3e50"/><path d="M1224.583,253.2246c-11.583,0-22.2539-1.8174-32.0166-5.4541-9.7656-3.6357-18.2148-8.7861-25.3506-15.4521-7.1396-6.666-12.6953-14.5098-16.665-23.5332-3.9736-9.0205-5.959-18.8525-5.959-29.4922,0-10.772,1.9854-20.6353,5.959-29.5928,3.9697-8.9541,9.5254-16.7661,16.665-23.4321,7.1357-6.666,15.585-11.8169,25.3506-15.4531,9.7627-3.6357,20.3672-5.4536,31.8154-5.4536,11.5801,0,22.2197,1.8179,31.916,5.4536,9.6953,3.6362,18.1104,8.7871,25.25,15.4531,7.1357,6.666,12.6904,14.478,16.6641,23.4321,3.9707,8.9575,5.96,18.8208,5.96,29.5928,0,10.6396-1.9893,20.4717-5.96,29.4922-3.9736,9.0234-9.5283,16.8672-16.6641,23.5332-7.1396,6.666-15.5547,11.8164-25.25,15.4521-9.6963,3.6367-20.2695,5.4541-31.7148,5.4541ZM1224.3819,214.6426c4.4434,0,8.585-.8076,12.4229-2.4238s7.2021-3.9385,10.0996-6.9688c2.8945-3.0303,5.1514-6.7324,6.7676-11.1104,1.6152-4.374,2.4238-9.3232,2.4238-14.8467,0-5.52-.8086-10.4692-2.4238-14.8467-1.6162-4.3745-3.873-8.0801-6.7676-11.1104-2.8975-3.0298-6.2617-5.3525-10.0996-6.9688s-7.9795-2.4238-12.4229-2.4238-8.585.8076-12.4238,2.4238c-3.8379,1.6162-7.2051,3.939-10.0996,6.9688-2.8975,3.0303-5.1514,6.7358-6.7666,11.1104-1.6162,4.3774-2.4248,9.3267-2.4248,14.8467,0,5.5234.8086,10.4727,2.4238,14.8467,1.6152,4.3779,3.8691,8.0801,6.7666,11.1104,2.8945,3.0303,6.2617,5.3525,10.0996,6.9688,3.8389,1.6162,7.9795,2.4238,12.4238,2.4238Z" fill="#2c3e50"/><path d="M1321.542,249.9932V108.5933h68.0742c13.1963,0,24.6094,2.1558,34.2393,6.4639,9.626,4.3115,17.0693,10.4727,22.3213,18.4829,5.252,8.0137,7.8779,17.4731,7.8779,28.3813s-2.626,20.3003-7.8779,28.1782-12.6953,13.9072-22.3213,18.0791c-9.6299,4.1758-21.043,6.2627-34.2393,6.2627h-41.6123l21.21-19.5947v55.1465h-47.6719ZM1369.2139,200.0986l-21.21-21.6133h38.582c6.5967,0,11.4795-1.4805,14.6455-4.4443,3.1621-2.9604,4.7471-7.0005,4.7471-12.1196s-1.585-9.1567-4.7471-12.1201c-3.166-2.9604-8.0488-4.4443-14.6455-4.4443h-38.582l21.21-21.6138v76.3555ZM1406.1807,249.9932l-34.7441-51.5098h50.5l35.1475,51.5098h-50.9033Z" fill="#2c3e50"/><path d="M1518.8955,214.0371h70.7002v35.9561h-117.5645V108.5933h114.9385v35.9561h-68.0742v69.4878ZM1515.6641,161.1133h63.0234v34.3398h-63.0234v-34.3398Z" fill="#2c3e50"/></g><g><circle cx="175.4063" cy="175" r="175" fill="#e74c3c"/><polygon points="246.6483 149.4986 176.2769 149.4986 211.3633 53.5342 104.1643 200.5014 174.5356 200.5014 139.4492 296.4658 246.6483 149.4986" fill="#ffd83b"/></g></svg>
					</div>
					<div class="digiblocks-promo-content">
						<p><?php echo wp_kses_post( __( 'A lightning-fast, ultra-lightweight theme designed specifically for DigiBlocks. Features a powerful site builder that lets you create custom <strong>headers</strong>, <strong>footers</strong>, <strong>archives</strong>, and <strong>page templates</strong> with intelligent display rules. Build beautiful, high-performance websites with minimal configuration and maximum flexibility.', 'digiblocks' ) ); ?></p>
						<div class="digiblocks-link-wrapper">
							<?php
							$digistore_status = $install->get_theme_status( 'digistore' );
							$button_action = $digistore_status['status'] === 'active' ? 'learn_more' : ($digistore_status['status'] === 'inactive' ? 'activate' : 'install');
							?>
							<button type="button" 
								class="digiblocks-button digiblocks-plugin-action <?php echo esc_attr( $digistore_status['button_class'] ); ?>"
								data-theme="digistore" 
								data-action="<?php echo esc_attr( $button_action ); ?>"
								data-type="theme"
								<?php if ( $digistore_status['status'] === 'active' ) : ?>
								data-url="<?php echo esc_url( $digistore_status['url'] ); ?>"
								<?php endif; ?>>
								<span><?php echo esc_html( $digistore_status['button_text'] ); ?></span>
								<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="1em" height="1em"><path d="M505 273c9.4-9.4 9.4-24.6 0-33.9L369 103c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l95 95L24 232c-13.3 0-24 10.7-24 24s10.7 24 24 24l406.1 0-95 95c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0L505 273z"/></svg>
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Resources Section -->
		<div class="digiblocks-admin-section digiblocks-resources-section">
			<div class="digiblocks-section-header">
				<h2><?php esc_html_e( 'Resources', 'digiblocks' ); ?></h2>
			</div>

			<div class="digiblocks-resources-container">
				<div class="digiblocks-resource-card">
					<div class="digiblocks-resource-title">
						<div class="digiblocks-resource-icon">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" width="24" height="24" fill="#526bfe"><path d="M352 448l0-256-112 0c-26.5 0-48-21.5-48-48l0-112L64 32C46.3 32 32 46.3 32 64l0 384c0 17.7 14.3 32 32 32l256 0c17.7 0 32-14.3 32-32zm-.5-288c-.7-2.8-2.1-5.4-4.2-7.4L231.4 36.7c-2.1-2.1-4.6-3.5-7.4-4.2L224 144c0 8.8 7.2 16 16 16l111.5 0zM0 64C0 28.7 28.7 0 64 0L220.1 0c12.7 0 24.9 5.1 33.9 14.1L369.9 129.9c9 9 14.1 21.2 14.1 33.9L384 448c0 35.3-28.7 64-64 64L64 512c-35.3 0-64-28.7-64-64L0 64z"/></svg>
						</div>
						<h3><?php esc_html_e( 'Documentation', 'digiblocks' ); ?></h3>
					</div>
					<div class="digiblocks-resource-content">
						<p><?php esc_html_e( 'Step-by-step guides to help you get the most out of DigiBlocks.', 'digiblocks' ); ?></p>
						<div class="digiblocks-link-wrapper">
							<a href="https://digihold.click/digiblocks-docs" target="_blank" class="digiblocks-link">
								<span><?php esc_html_e( 'View Documentation', 'digiblocks' ); ?></span>
								<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="1em" height="1em"><path d="M505 273c9.4-9.4 9.4-24.6 0-33.9L369 103c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l95 95L24 232c-13.3 0-24 10.7-24 24s10.7 24 24 24l406.1 0-95 95c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0L505 273z"/></svg>
							</a>
						</div>
					</div>
				</div>

				<div class="digiblocks-resource-card">
					<div class="digiblocks-resource-title">
						<div class="digiblocks-resource-icon">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="24" height="24" fill="#526bfe"><path d="M32 256C32 132.3 132.3 32 256 32s224 100.3 224 224l0 144.1c0 26.5-21.5 48-48 48l-82.7-.1c-6.6-18.6-24.4-32-45.3-32l-64 0c-26.5 0-48 21.5-48 48s21.5 48 48 48l64 0c20.9 0 38.7-13.4 45.3-32l82.7 .1c44.2 0 80.1-35.8 80.1-80L512 256C512 114.6 397.4 0 256 0S0 114.6 0 256l0 48c0 8.8 7.2 16 16 16s16-7.2 16-16l0-48zM320 464c0 8.8-7.2 16-16 16l-64 0c-8.8 0-16-7.2-16-16s7.2-16 16-16l64 0c8.8 0 16 7.2 16 16zM144 224l16 0 0 128-16 0c-26.5 0-48-21.5-48-48l0-32c0-26.5 21.5-48 48-48zM64 272l0 32c0 44.2 35.8 80 80 80l16 0c17.7 0 32-14.3 32-32l0-128c0-17.7-14.3-32-32-32l-16 0c-44.2 0-80 35.8-80 80zm288-48l16 0c26.5 0 48 21.5 48 48l0 32c0 26.5-21.5 48-48 48l-16 0 0-128zm16-32l-16 0c-17.7 0-32 14.3-32 32l0 128c0 17.7 14.3 32 32 32l16 0c44.2 0 80-35.8 80-80l0-32c0-44.2-35.8-80-80-80z"/></svg>
						</div>
						<h3><?php esc_html_e( 'Expert Support', 'digiblocks' ); ?></h3>
					</div>
					<div class="digiblocks-resource-content">
						<p><?php esc_html_e( 'Get help from our dedicated team whenever you face an issue.', 'digiblocks' ); ?></p>
						<div class="digiblocks-link-wrapper">
							<a href="https://digihold.click/digiblocks-support" target="_blank" class="digiblocks-link">
								<span><?php esc_html_e( 'Get Support', 'digiblocks' ); ?></span>
								<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="1em" height="1em"><path d="M505 273c9.4-9.4 9.4-24.6 0-33.9L369 103c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l95 95L24 232c-13.3 0-24 10.7-24 24s10.7 24 24 24l406.1 0-95 95c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0L505 273z"/></svg>
							</a>
						</div>
					</div>
				</div>

				<div class="digiblocks-resource-card">
					<div class="digiblocks-resource-title">
						<div class="digiblocks-resource-icon">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" width="24" height="24" fill="#526bfe"><path d="M80 299.3V512H196V299.3h86.5l18-97.8H196V166.9c0-51.7 20.3-71.5 72.7-71.5c16.3 0 29.4 .4 37 1.2V7.9C291.4 4 256.4 0 236.2 0C129.3 0 80 50.5 80 159.4v42.1H14v97.8H80z"/></svg>
						</div>
						<h3><?php esc_html_e( 'Join Community', 'digiblocks' ); ?></h3>
					</div>
					<div class="digiblocks-resource-content">
						<p><?php esc_html_e( 'Connect with other users and developers to share ideas and solutions.', 'digiblocks' ); ?></p>
						<div class="digiblocks-link-wrapper">
							<a href="https://digihold.click/digiblocks-fb" target="_blank" class="digiblocks-link">
								<span><?php esc_html_e( 'Connect with Us', 'digiblocks' ); ?></span>
								<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="1em" height="1em"><path d="M505 273c9.4-9.4 9.4-24.6 0-33.9L369 103c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l95 95L24 232c-13.3 0-24 10.7-24 24s10.7 24 24 24l406.1 0-95 95c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0L505 273z"/></svg>
							</a>
						</div>
					</div>
				</div>

				<div class="digiblocks-resource-card">
					<div class="digiblocks-resource-title">
						<div class="digiblocks-resource-icon">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" width="24" height="24" fill="#526bfe"><path d="M226.5 168.8L287.9 42.3l61.4 126.5c4.6 9.5 13.6 16.1 24.1 17.7l137.4 20.3-99.8 98.8c-7.4 7.3-10.8 17.8-9 28.1l23.5 139.5L303 407.7c-9.4-5-20.7-5-30.2 0L150.2 473.2l23.5-139.5c1.7-10.3-1.6-20.7-9-28.1L65 206.8l137.4-20.3c10.5-1.5 19.5-8.2 24.1-17.7zM424.9 509.1c8.1 4.3 17.9 3.7 25.3-1.7s11.2-14.5 9.7-23.5L433.6 328.4 544.8 218.2c6.5-6.4 8.7-15.9 5.9-24.5s-10.3-14.9-19.3-16.3L378.1 154.8 309.5 13.5C305.5 5.2 297.1 0 287.9 0s-17.6 5.2-21.6 13.5L197.7 154.8 44.5 177.5c-9 1.3-16.5 7.6-19.3 16.3s-.5 18.1 5.9 24.5L142.2 328.4 116 483.9c-1.5 9 2.2 18.1 9.7 23.5s17.3 6 25.3 1.7l137-73.2 137 73.2z"/></svg>
						</div>
						<h3><?php esc_html_e( 'Rate DigiBlocks', 'digiblocks' ); ?></h3>
					</div>
					<div class="digiblocks-resource-content">
						<p><?php esc_html_e( 'Enjoying DigiBlocks? Show your support by leaving a review.', 'digiblocks' ); ?></p>
						<div class="digiblocks-link-wrapper">
							<a href="https://digihold.click/digiblocks-reviews" target="_blank" class="digiblocks-link">
								<span><?php esc_html_e( 'Leave a Review', 'digiblocks' ); ?></span>
								<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="1em" height="1em"><path d="M505 273c9.4-9.4 9.4-24.6 0-33.9L369 103c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l95 95L24 232c-13.3 0-24 10.7-24 24s10.7 24 24 24l406.1 0-95 95c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0L505 273z"/></svg>
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>
		<?php
		return ob_get_clean();
	}

	/**
	 * Generate block assets (CSS and JS) for a post.
	 *
	 * @param int     $post_id Post ID.
	 * @param WP_Post $post Post object.
	 */
	public function generate_block_assets( $post_id, $post ) {
		// Skip if this is an autosave, a revision, or a restore.
		if ( wp_is_post_autosave( $post_id ) || wp_is_post_revision( $post_id ) || ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE ) ) {
			return;
		}

		// Skip if post status is 'auto-draft'.
		if ( 'auto-draft' === $post->post_status ) {
			return;
		}

		// Skip if post type doesn't support the block editor.
		if ( ! use_block_editor_for_post_type( $post->post_type ) ) {
			return;
		}

		$content = $post->post_content;

		// Check if content has any DigiBlocks blocks.
		if ( false === strpos( $content, '<!-- wp:digiblocks/' ) ) {
			// No DigiBlocks found, clean up existing files.
			$this->cleanup_block_assets( $post_id );
			return;
		}

		// Extract CSS and JS from blocks.
		$css = $this->extract_block_css( $content, $post_id );
		$js  = $this->extract_block_js( $content, $post_id );

		// Generate assets.
		$this->generate_css_file( $post_id, $css );
		$this->generate_js_file( $post_id, $js );
	}

	/**
	 * Extract CSS from blocks.
	 *
	 * @param string $content Post content.
	 * @param int    $post_id Post ID.
	 * @return string Combined CSS.
	 */
	private function extract_block_css( $content, $post_id ) {
		$css = '';
		$blocks = parse_blocks( $content );
		
		// Process blocks recursively.
		$css = $this->process_blocks_for_css( $blocks, $post_id );
		return $css;
	}

	/**
	 * Process blocks recursively to extract CSS.
	 *
	 * @param array $blocks Array of blocks.
	 * @param int   $post_id Post ID.
	 * @return string Combined CSS.
	 */
	private function process_blocks_for_css( $blocks, $post_id ) {
		$css = '';
		$digiblock_count = 0;
	
		foreach ( $blocks as $block ) {
			// Check if this is a DigiBlocks block.
			if ( isset( $block['blockName'] ) && 0 === strpos( $block['blockName'], 'digiblocks/' ) ) {
				$digiblock_count++;
				$block_name = str_replace( 'digiblocks/', '', $block['blockName'] );
				$block_instance_id = isset( $block['attrs']['id'] ) ? $block['attrs']['id'] : uniqid( 'digiblock-' );
	
				// Ensure attrs is always an array
				$block_attrs = isset( $block['attrs'] ) && is_array( $block['attrs'] ) ? $block['attrs'] : array();
	
				// Pass the block ID and attributes to get_block_css
				$block_css = $this->get_block_css( $block_name, $block_instance_id, $block_attrs );
				$css .= $block_css;
			}
	
			// Process inner blocks.
			if ( ! empty( $block['innerBlocks'] ) ) {
				$inner_css = $this->process_blocks_for_css( $block['innerBlocks'], $post_id );
				$css .= $inner_css;
			}
		}
		return $css;
	}

	/**
	 * Get block-specific CSS.
	 *
	 * @param string $block_name Block name.
	 * @param string $block_id Block ID.
	 * @param array  $attrs Block attributes.
	 * @return string Block CSS.
	 */
	private function get_block_css( $block_name, $block_id, $attrs ) {
		$block_css_file = DIGIBLOCKS_PLUGIN_DIR . 'blocks/' . $block_name . '/styles.php';
	
		if ( file_exists( $block_css_file ) ) {
			// Ensure attrs is always an array
			if ( ! is_array( $attrs ) ) {
				$attrs = array();
			}
	
			// Create a variable that will be accessible in the included file
			$digiblocks_css_output = '';
			
			// Wrap include in try-catch to handle any errors in the styles file
			try {
				// Include the file - it will set $digiblocks_css_output
				include $block_css_file;
			} catch ( Exception $e ) {
				return '';
			} catch ( Error $e ) {
				return '';
			}
			
			// Return the CSS set by the included file
			return $digiblocks_css_output;
		}
	
		return '';
	}

	/**
	 * Extract JS from blocks.
	 *
	 * @param string $content Post content.
	 * @param int    $post_id Post ID.
	 * @return string Combined JS.
	 */
	private function extract_block_js( $content, $post_id ) {
		$js     = '';
		$blocks = parse_blocks( $content );

		// Process blocks recursively.
		$js = $this->process_blocks_for_js( $blocks, $post_id );

		return $js;
	}

	/**
	 * Process blocks recursively to extract JS.
	 *
	 * @param array $blocks Array of blocks.
	 * @param int   $post_id Post ID.
	 * @return string Combined JS.
	 */
	private function process_blocks_for_js( $blocks, $post_id ) {
		$js = '';
	
		foreach ( $blocks as $block ) {
			// Check if this is a DigiBlocks block.
			if ( isset( $block['blockName'] ) && 0 === strpos( $block['blockName'], 'digiblocks/' ) ) {
				$block_name        = str_replace( 'digiblocks/', '', $block['blockName'] );
				$block_instance_id = isset( $block['attrs']['id'] ) ? $block['attrs']['id'] : uniqid( 'digiblock-' );
	
				// Ensure attrs is always an array
				$block_attrs = isset( $block['attrs'] ) && is_array( $block['attrs'] ) ? $block['attrs'] : array();
	
				// Get block-specific JS.
				$block_js = $this->get_block_js( $block_name, $block_instance_id, $block_attrs );
				$js      .= $block_js;
			}
	
			// Process inner blocks.
			if ( ! empty( $block['innerBlocks'] ) ) {
				$js .= $this->process_blocks_for_js( $block['innerBlocks'], $post_id );
			}
		}
	
		return $js;
	}

	/**
	 * Get block-specific JS.
	 *
	 * @param string $block_name Block name.
	 * @param string $block_id Block ID.
	 * @param array  $attrs Block attributes.
	 * @return string Block JS.
	 */
	private function get_block_js( $block_name, $block_id, $attrs ) {
		$block_js_file = DIGIBLOCKS_PLUGIN_DIR . 'blocks/' . $block_name . '/script.php';
	
		if ( file_exists( $block_js_file ) ) {
			// Ensure attrs is always an array
			if ( ! is_array( $attrs ) ) {
				$attrs = array();
			}
	
			// Create a variable that will be accessible in the included file
			$digiblocks_js_output = '';
			
			// Wrap include in try-catch to handle any errors in the script file
			try {
				// Include the file - it will set $digiblocks_js_output
				include $block_js_file;
			} catch ( Exception $e ) {
				return '';
			} catch ( Error $e ) {
				return '';
			}
			
			// Return the JS set by the included file
			return $digiblocks_js_output;
		}
	
		return '';
	}

	/**
	 * Generate CSS file for a post.
	 *
	 * @param int    $post_id Post ID.
	 * @param string $css CSS content.
	 */
	public function generate_css_file( $post_id, $css ) {
		// Initialize WP_Filesystem
		global $wp_filesystem;
		if ( ! is_object( $wp_filesystem ) ) {
			require_once ABSPATH . 'wp-admin/includes/file.php';
			$filesystem_init = WP_Filesystem();
		}

		$css_file = DIGIBLOCKS_ASSETS_DIR . '/digiblocks-' . $post_id . '.css';

		if ( empty( $css ) ) {
			// Clean up CSS file if it exists.
			if ( $wp_filesystem->exists( $css_file ) ) {
				$delete_result = $wp_filesystem->delete( $css_file );
			}
			return;
		}

		// Ensure digiblocks directory exists in uploads folder.
		if ( ! file_exists( DIGIBLOCKS_ASSETS_DIR ) ) {
			$mkdir_result = wp_mkdir_p( DIGIBLOCKS_ASSETS_DIR );
		}

		// Direct file system access backup in case WP_Filesystem fails
		if ( ! $wp_filesystem || ! is_object( $wp_filesystem ) ) {
			// Try to initialize a direct file system instance as fallback
			if ( ! class_exists( 'WP_Filesystem_Direct' ) ) {
				require_once ABSPATH . 'wp-admin/includes/class-wp-filesystem-base.php';
				require_once ABSPATH . 'wp-admin/includes/class-wp-filesystem-direct.php';
			}
			$wp_filesystem_direct = new WP_Filesystem_Direct( null );
			$write_result = $wp_filesystem_direct->put_contents( $css_file, $css, FS_CHMOD_FILE );
			return;
		}

		// Minify CSS.
		$css = $this->minify_css( $css );

		// Write CSS file.
		$put_result = $wp_filesystem->put_contents( $css_file, $css, FS_CHMOD_FILE );
	}

	/**
	 * Generate JS file for a post.
	 *
	 * @param int    $post_id Post ID.
	 * @param string $js JS content.
	 */
	public function generate_js_file( $post_id, $js ) {
		// Initialize WP_Filesystem
		global $wp_filesystem;
		if ( ! is_object( $wp_filesystem ) ) {
			require_once ABSPATH . 'wp-admin/includes/file.php';
			$filesystem_init = WP_Filesystem();
		}

		$js_file = DIGIBLOCKS_ASSETS_DIR . '/digiblocks-' . $post_id . '.js';

		if ( empty( $js ) ) {
			// Clean up JS file if it exists.
			if ( $wp_filesystem->exists( $js_file ) ) {
				$delete_result = $wp_filesystem->delete( $js_file );
			}
			return;
		}

		// Ensure digiblocks directory exists in uploads folder.
		if ( ! file_exists( DIGIBLOCKS_ASSETS_DIR ) ) {
			$mkdir_result = wp_mkdir_p( DIGIBLOCKS_ASSETS_DIR );
		}

		// Direct file system access backup in case WP_Filesystem fails
		if ( ! $wp_filesystem || ! is_object( $wp_filesystem ) ) {
			// Try to initialize a direct file system instance as fallback
			if ( ! class_exists( 'WP_Filesystem_Direct' ) ) {
				require_once ABSPATH . 'wp-admin/includes/class-wp-filesystem-base.php';
				require_once ABSPATH . 'wp-admin/includes/class-wp-filesystem-direct.php';
			}
			$wp_filesystem_direct = new WP_Filesystem_Direct( null );
			$write_result = $wp_filesystem_direct->put_contents( $js_file, $js, FS_CHMOD_FILE );
			return;
		}

		// Minify JS.
		$js = $this->minify_js( $js );

		// Write JS file.
		$put_result = $wp_filesystem->put_contents( $js_file, $js, FS_CHMOD_FILE );
	}

	/**
	 * Minify CSS.
	 *
	 * @param string $css CSS content.
	 * @return string Minified CSS.
	 */
	private function minify_css( $css ) {
		// Remove comments.
		$css = preg_replace( '!/\*[^*]*\*+([^/][^*]*\*+)*/!', '', $css );
		
		// Ensure preg_replace didn't fail
		if ( null === $css ) {
			return '';
		}

		// Remove space after colons.
		$css = str_replace( ': ', ':', $css );
		
		// Remove whitespace.
		$css = str_replace( array( "\r\n", "\r", "\n", "\t", '  ', '    ', '    ' ), '', $css );

		return $css;
	}

	/**
	 * Minify JS.
	 *
	 * @param string $js JS content.
	 * @return string Minified JS.
	 */
	private function minify_js( $js ) {
		// Ensure JS is a string
		if ( ! is_string( $js ) || empty( $js ) ) {
			return '';
		}
	
		// Remove comments (single line).
		$js = preg_replace( '/(\/\/[^\n]*\n)/', '', $js );
		if ( null === $js ) {
			return '';
		}
	
		// Remove comments (multi-line).
		$js = preg_replace( '/(\/\*.*?\*\/)/', '', $js );
		if ( null === $js ) {
			return '';
		}
	
		// Remove whitespace.
		$js = preg_replace( '/\s+/', ' ', $js );
		if ( null === $js ) {
			return '';
		}
	
		return trim( $js );
	}

	/**
	 * Clean up block assets.
	 *
	 * @param int $post_id Post ID.
	 */
	public function cleanup_block_assets( $post_id ) {
		$css_file = DIGIBLOCKS_ASSETS_DIR . '/digiblocks-' . $post_id . '.css';
		$js_file  = DIGIBLOCKS_ASSETS_DIR . '/digiblocks-' . $post_id . '.js';

		if ( file_exists( $css_file ) ) {
			wp_delete_file( $css_file );
		}

		if ( file_exists( $js_file ) ) {
			wp_delete_file( $js_file );
		}
	}

	/**
	 * Enqueue block assets on front-end.
	 */
	public function enqueue_block_assets() {
		global $post;

		if ( ! is_singular() || empty( $post ) ) {
			return;
		}

		$post_id  = $post->ID;
		$css_file = DIGIBLOCKS_ASSETS_DIR . '/digiblocks-' . $post_id . '.css';
		$js_file  = DIGIBLOCKS_ASSETS_DIR . '/digiblocks-' . $post_id . '.js';

		// Check if post content has DigiBlocks blocks
		if ( has_blocks( $post->post_content ) ) {
			$blocks         = parse_blocks( $post->post_content );
			$has_digiblocks = $this->has_digiblocks_blocks( $blocks );

			if ( $has_digiblocks ) {
				// Enqueue the CSS file
				if ( file_exists( $css_file ) ) {
					wp_enqueue_style(
						'digiblocks-' . $post_id,
						DIGIBLOCKS_ASSETS_URL . '/digiblocks-' . $post_id . '.css',
						array(),
						filemtime( $css_file )
					);
				}

				// Enqueue the JS file
				if ( file_exists( $js_file ) ) {
					wp_enqueue_script(
						'digiblocks-' . $post_id,
						DIGIBLOCKS_ASSETS_URL . '/digiblocks-' . $post_id . '.js',
						array(),
						filemtime( $js_file ),
						true
					);

					// Consolidate all localized data into one call
					$this->enqueue_consolidated_script_data( 'digiblocks-' . $post_id, $blocks );
				}

				// Check for Google Map block and enqueue the Google Maps API if needed
				if ( $this->has_google_map_blocks( $blocks ) ) {
					$this->enqueue_google_maps_api();
				}

				// Check for Lottie block and enqueue
				if ( $this->has_lottie_blocks( $blocks ) ) {
					$this->enqueue_lottie_if_needed( $post_id, $blocks );
				}

				// Check for blocks with animations and enqueue if needed
				$this->enqueue_animations_if_needed( $post_id, $blocks );
			}
		}
	}

	/**
	 * Consolidate all script data into a single wp_localize_script call
	 *
	 * @param string $script_handle Script handle to attach data to
	 * @param array  $blocks Array of parsed blocks
	 */
	private function enqueue_consolidated_script_data( $script_handle, $blocks ) {
		// Get settings once
		$settings = get_option( 'digiblocks_settings', array() );
		
		// Initialize consolidated data array with common data
		$consolidated_data = array(
			'ajax_url' => admin_url( 'admin-ajax.php' ),
		);

		// Check for Forms blocks
		if ( $this->has_specific_block( $blocks, 'digiblocks/forms' ) ) {
			$recaptcha_site_key   = isset( $settings['recaptcha_site_key'] ) ? $settings['recaptcha_site_key'] : '';
			$recaptcha_secret_key = isset( $settings['recaptcha_secret_key'] ) ? $settings['recaptcha_secret_key'] : '';

			// Enqueue Google reCAPTCHA if needed
			if ( ! empty( $recaptcha_site_key ) && ! empty( $recaptcha_secret_key ) ) {
				wp_enqueue_script(
					'google-recaptcha',
					'https://www.google.com/recaptcha/api.js?render=' . $recaptcha_site_key,
					array(),
					null,
					true
				);
			}

			$consolidated_data['forms'] = array(
				'form_nonce'         => wp_create_nonce( 'digiblocks_form_nonce' ),
				'recaptcha_site_key' => $recaptcha_site_key,
			);
		}

		// Check for Newsletter blocks
		if ( $this->has_specific_block( $blocks, 'digiblocks/newsletter' ) ) {
			$consolidated_data['newsletter'] = array(
				'nonce' => wp_create_nonce( 'digiblocks_newsletter_nonce' ),
			);
		}

		// Check for Search Form blocks
		if ( $this->has_specific_block( $blocks, 'digiblocks/search-form' ) ) {
			$consolidated_data['search'] = array(
				'search_nonce' => wp_create_nonce( 'digiblocks_search_nonce' ),
				'home_url'     => home_url(),
			);
		}

		// Check for WooCommerce Add to Cart blocks
		if ( $this->has_specific_block( $blocks, 'digiblocks/woo-product-add-to-cart' ) ) {
			$consolidated_data['wooAddToCart'] = array(
				'nonce' => wp_create_nonce( 'digiblocks_add_to_cart' ),
			);
		}

		// Check for DigiCommerce Add to Cart blocks
		if ( $this->has_specific_block( $blocks, 'digiblocks/digi-product-add-to-cart' ) ) {
			$consolidated_data['digiAddToCart'] = array(
				'nonce' => wp_create_nonce( 'digiblocks_digi_add_to_cart' ),
			);
		}

		// Check for Cart Icon blocks (both WooCommerce and DigiCommerce)
		if ( $this->has_specific_block( $blocks, 'digiblocks/woo-cart-icon' ) || $this->has_specific_block( $blocks, 'digiblocks/digi-cart-icon' ) ) {
			$consolidated_data['cart'] = array(
				'cart_nonce' => wp_create_nonce( 'digiblocks_cart_nonce' ),
			);

			// Add DigiCommerce specific nonce if DigiCommerce is active
			if ( class_exists( 'DigiCommerce' ) ) {
				$consolidated_data['digiCart'] = array(
					'order_nonce' => wp_create_nonce( 'digicommerce_order_nonce' ),
				);
			}
		}

		// Only localize if we have more than just ajax_url
		if ( count( $consolidated_data ) > 1 ) {
			wp_localize_script( $script_handle, 'digiBlocksData', $consolidated_data );
		}
	}

	/**
	 * Generic method to check for specific block types recursively
	 *
	 * @param array  $blocks Array of parsed blocks.
	 * @param string $block_name Block name to search for.
	 * @return bool True if block is found.
	 */
	private function has_specific_block( $blocks, $block_name ) {
		foreach ( $blocks as $block ) {
			if ( isset( $block['blockName'] ) && $block['blockName'] === $block_name ) {
				return true;
			}
			
			if ( ! empty( $block['innerBlocks'] ) ) {
				if ( $this->has_specific_block( $block['innerBlocks'], $block_name ) ) {
					return true;
				}
			}
		}
		
		return false;
	}

	/**
	 * Check if blocks array contains any DigiBlocks blocks.
	 *
	 * @param array $blocks Array of parsed blocks.
	 * @return bool True if DigiBlocks blocks are found.
	 */
	private function has_digiblocks_blocks( $blocks ) {
		foreach ( $blocks as $block ) {
			if ( isset( $block['blockName'] ) && 0 === strpos( $block['blockName'], 'digiblocks/' ) ) {
				return true;
			}
			
			if ( ! empty( $block['innerBlocks'] ) ) {
				if ( $this->has_digiblocks_blocks( $block['innerBlocks'] ) ) {
					return true;
				}
			}
		}
		
		return false;
	}

	/**
	 * Enqueue Google Maps API.
	 */
	private function enqueue_google_maps_api() {
		// Get API key from settings
		$settings = get_option('digiblocks_settings', array());
		$api_key = isset($settings['google_maps_api_key']) ? $settings['google_maps_api_key'] : '';

		if (!empty($api_key)) {
			wp_enqueue_script(
				'google-maps-api',
				'https://maps.googleapis.com/maps/api/js?key=' . esc_attr($api_key) . '&callback=digiblocksGoogleMapsCallback&loading=async',
				array(),
				null, // phpcs:ignore
				true
			);
		}
	}

	/**
	 * Check if any DigiBlocks with animations are present on the page.
	 *
	 * @param array $blocks Array of parsed blocks.
	 * @return bool True if animations are found.
	 */
	private function has_block_animations( $blocks ) {
		foreach ( $blocks as $block ) {
			// Check if this is a DigiBlocks block with animation attribute
			if ( isset( $block['blockName'] ) && 
				0 === strpos( $block['blockName'], 'digiblocks/' ) && 
				isset( $block['attrs']['animation'] ) && 
				$block['attrs']['animation'] !== 'none' ) {
				return true;
			}
			
			// Check inner blocks recursively
			if ( ! empty( $block['innerBlocks'] ) ) {
				if ( $this->has_block_animations( $block['innerBlocks'] ) ) {
					return true;
				}
			}
		}
		
		return false;
	}

	/**
	 * Enqueue animations script if needed.
	 *
	 * @param int $post_id Post ID.
	 * @param array $blocks Parsed blocks from content.
	 */
	private function enqueue_animations_if_needed( $post_id, $blocks ) {
		static $animations_enqueued = false;
		
		// Check if animations are already enqueued
		if ( $animations_enqueued ) {
			return;
		}
		
		// Check if any block has animations
		if ( $this->has_block_animations( $blocks ) ) {
			wp_enqueue_script(
				'digiblocks-animations',
				DIGIBLOCKS_PLUGIN_URL . 'assets/js/front-animations.js',
				array(),
				DIGIBLOCKS_VERSION,
				true
			);
			
			$animations_enqueued = true;
		}
	}

	/**
	 * Add admin menu.
	 */
	public function add_admin_menu() {
		$icon = 'data:image/svg+xml;base64,' . base64_encode( $this->get_plugin_icon() ); // phpcs:ignore

		add_menu_page(
			__( 'DigiBlocks', 'digiblocks' ),
			__( 'DigiBlocks', 'digiblocks' ),
			'manage_options',
			'digiblocks',
			array( $this, 'render_dashboard_page' ),
			$icon,
			58
		);

		add_submenu_page(
			'digiblocks',
			__( 'Dashboard', 'digiblocks' ),
			__( 'Dashboard', 'digiblocks' ),
			'manage_options',
			'digiblocks',
			array( $this, 'render_dashboard_page' )
		);

		add_submenu_page(
			'digiblocks',
			__( 'Settings', 'digiblocks' ),
			__( 'Settings', 'digiblocks' ),
			'manage_options',
			'digiblocks-settings',
			array( $this, 'render_settings_page' )
		);
	}

	/**
	 * Render dashboard page.
	 */
	public function render_dashboard_page() {
		include DIGIBLOCKS_PLUGIN_DIR . 'admin/dashboard.php';
	}

	/**
	 * Render settings page.
	 */
	public function render_settings_page() {
		include DIGIBLOCKS_PLUGIN_DIR . 'admin/settings.php';
	}

	/**
	 * Enqueue editor assets
	 */
	public function enqueue_editor_assets() {
		// Style for editor.
		wp_enqueue_style(
			'digiblocks-editor',
			DIGIBLOCKS_PLUGIN_URL . 'assets/css/blocks/editor.css',
			array( 'wp-edit-blocks' ),
			DIGIBLOCKS_VERSION
		);

		// First enqueue the globals script
		wp_enqueue_script(
			'digiblocks-globals',
			DIGIBLOCKS_PLUGIN_URL . 'assets/js/globals.js',
			array(
				'wp-blocks',
				'wp-i18n',
				'wp-element',
				'wp-editor',
				'wp-components',
				'wp-data',
				'wp-block-editor',
			),
			DIGIBLOCKS_VERSION,
			true
		);

		// Enqueue editor scripts.
		wp_enqueue_script(
			'digiblocks-blocks-editor',
			DIGIBLOCKS_PLUGIN_URL . 'assets/js/blocks/index.js',
			array(
				'wp-blocks',
				'wp-i18n',
				'wp-element',
				'wp-editor',
				'wp-components',
				'wp-data',
				'wp-block-editor',
				'digiblocks-globals',
			),
			DIGIBLOCKS_VERSION,
			true
		);

		// Get settings
		$settings = get_option('digiblocks_settings', array());

		// Get default width and max width
		$content_width = !empty($settings['content_width']) ? intval($settings['content_width']) : 1200;
		$content_max_width = !empty($settings['content_max_width']) ? intval($settings['content_max_width']) : 90;

		// Google Map API key.
		$settings = get_option('digiblocks_settings', array());
		$google_maps_api_key = isset($settings['google_maps_api_key']) ? $settings['google_maps_api_key'] : '';
		$google_maps_map_id = isset($settings['google_maps_map_id']) ? $settings['google_maps_map_id'] : '';

		// Add FA icons to the editor.
		wp_localize_script(
			'digiblocks-globals',
			'digiBlocksData',
			array(
				'fontAwesomeIcons'     => $this->get_fa_icons(),
				'blocks'               => DigiBlocks_Blocks_Data::get_block_data(),
				'inactiveBlocks'       => get_option( 'digiblocks_inactive_blocks', array() ),
				'contentWidth'         => $content_width,
				'contentMaxWidth'      => $content_max_width,
				'googleMapsApiKey'     => $google_maps_api_key,
				'googleMapsMapId'      => $google_maps_map_id,
				'navigation_nonce'     => wp_create_nonce( 'digiblocks_nav_nonce' ),
				'isDigiActive'         => class_exists( 'DigiCommerce' ),
				'isDigiProActive'      => class_exists( 'DigiCommerce_Pro' ),
				'digiCurrency'         => ( class_exists( 'DigiCommerce' ) && class_exists( 'DigiCommerce_Product' ) ) ? DigiCommerce_Product::instance()->get_currency_symbol( DigiCommerce()->get_option( 'currency', 'USD' ) ) : '$',
        		'digiCurrencyPosition' => class_exists( 'DigiCommerce' ) ? DigiCommerce()->get_option( 'currency_position', 'left' ) : 'left',
				'isWooActive'          => class_exists( 'WooCommerce' ),
				'lottie'               => DIGIBLOCKS_PLUGIN_URL . 'assets/js/lottie.js',
				'postTypes'            => $this->get_searchable_post_types(),
				'homeUrl'              => home_url(),
			)
		);
	}

	/**
	 * Get Font Awesome icons.
	 */
	public function get_fa_icons() {
		$icons = array_merge(
			require_once plugin_dir_path( __FILE__ ) . 'icons/v6-0.php',
			require_once plugin_dir_path( __FILE__ ) . 'icons/v6-1.php',
			require_once plugin_dir_path( __FILE__ ) . 'icons/v6-2.php',
			require_once plugin_dir_path( __FILE__ ) . 'icons/v6-3.php',
		);

		// Allow developers to add custom icons
		return apply_filters( 'digiblocks_fa_icons', $icons );
	}

	/**
	 * Enqueue admin scripts.
	 *
	 * @param string $hook Hook suffix.
	 */
	public function enqueue_admin_scripts( $hook ) {
		// Load only on DigiBlocks admin pages.
		if ( 'toplevel_page_digiblocks' === $hook || 'digiblocks_page_digiblocks-settings' === $hook ) {
			wp_enqueue_style(
				'digiblocks-admin',
				DIGIBLOCKS_PLUGIN_URL . 'assets/css/admin/admin.css',
				array(),
				DIGIBLOCKS_VERSION
			);

			wp_enqueue_script(
				'digiblocks-admin',
				DIGIBLOCKS_PLUGIN_URL . 'assets/js/admin/admin.js',
				array( 'wp-api', 'wp-i18n' ),
				DIGIBLOCKS_VERSION,
				true
			);

			wp_localize_script(
				'digiblocks-admin',
				'digiBlocksAdmin',
				array(
					'apiNonce' => wp_create_nonce( 'wp_rest' ),
					'apiUrl'   => rest_url( 'digiblocks/v1/' ),
					'ajaxUrl'  => admin_url( 'admin-ajax.php' ),
					'nonce'    => wp_create_nonce( 'digiblocks_plugin_action' ),
					'strings'  => array(
						// General strings
						'saving'               => __( 'Saving...', 'digiblocks' ),
						'saved'                => __( 'Settings saved successfully!', 'digiblocks' ),
						'saveError'            => __( 'Error saving settings.', 'digiblocks' ),
						'networkError'         => __( 'Network error occurred. Please try again.', 'digiblocks' ),
						
						// Regenerate functionality
						'regenerateButton'     => __( 'Regenerate All Assets', 'digiblocks' ),
						'confirmRegenerate'    => __( 'This will regenerate all DigiBlocks assets including builder elements. This may take a few moments. Continue?', 'digiblocks' ),
						'regenerating'         => __( 'Regenerating assets...', 'digiblocks' ),
						'postsProcessed'       => __( 'Posts processed: ', 'digiblocks' ),
						'buildersProcessed'    => __( 'Builders processed: ', 'digiblocks' ),
						'cssFiles'             => __( 'CSS files: ', 'digiblocks' ),
						'jsFiles'              => __( 'JS files: ', 'digiblocks' ),
						'fontFiles'            => __( 'Font files: ', 'digiblocks' ),
						'errors'               => __( 'Errors:', 'digiblocks' ),
						'regenerateError'      => __( 'An error occurred while regenerating assets.', 'digiblocks' ),
						'regenerateSuccess'    => __( 'Assets regenerated successfully!', 'digiblocks' ),
						
						// Block management
						'blockActivated'       => __( 'Block activated', 'digiblocks' ),
						'blockDeactivated'     => __( 'Block deactivated', 'digiblocks' ),
						'blockSaveError'       => __( 'Error saving block settings', 'digiblocks' ),

						// Plugin/theme installation and activation
						'installing'    => __( 'Installing...', 'digiblocks' ),
						'activating'    => __( 'Activating...', 'digiblocks' ),
						'install_plugin' => __( 'Install Plugin', 'digiblocks' ),
						'install_theme'  => __( 'Install Theme', 'digiblocks' ),
						'activate_plugin' => __( 'Activate Plugin', 'digiblocks' ),
						'activate_theme'  => __( 'Activate Theme', 'digiblocks' ),
						'learn_more'     => __( 'Learn More', 'digiblocks' ),
						'error'          => __( 'An error occurred. Please try again.', 'digiblocks' ),
					),
				)
			);
		}
	}

	/**
	 * Enqueue lottie script if needed
	 * 
	 * @param int $post_id Post ID.
	 * @param array $blocks Parsed blocks from content.
	 */
	private function enqueue_lottie_if_needed($post_id, $blocks) {
		static $lottie_enqueued = false;
		
		// Check if lottie js is already enqueued
		if ($lottie_enqueued) {
			return;
		}
		
		// Check if any block has lottie
		if ($this->has_lottie_blocks($blocks)) {
			wp_enqueue_script(
				'digiblocks-lottie-player',
				DIGIBLOCKS_PLUGIN_URL . 'assets/js/lottie.js',
				array(),
				DIGIBLOCKS_VERSION,
				true
			);
			
			$lottie_enqueued = true;
		}
	}

	/**
	 * Register REST API routes.
	 */
	public function register_rest_routes() {
		register_rest_route(
			'digiblocks/v1',
			'/update-settings',
			array(
				'methods'             => 'POST',
				'callback'            => array( $this, 'update_settings' ),
				'permission_callback' => function () {
					return current_user_can( 'manage_options' );
				},
			)
		);

		register_rest_route(
			'digiblocks/v1',
			'/update-blocks',
			array(
				'methods'             => 'POST',
				'callback'            => array( $this, 'update_active_blocks' ),
				'permission_callback' => function () {
					return current_user_can( 'manage_options' );
				},
			)
		);

		register_rest_route(
			'digiblocks/v1',
			'/regenerate-assets',
			array(
				'methods'             => 'POST',
				'callback'            => array( $this, 'regenerate_all_assets' ),
				'permission_callback' => function () {
					return current_user_can( 'manage_options' );
				},
			)
		);
	}

	/**
	 * Update settings.
	 *
	 * @param WP_REST_Request $request Request object.
	 * @return WP_REST_Response Response object.
	 */
	public function update_settings( $request ) {
		$settings         = $request->get_json_params();
		$current_settings = get_option( 'digiblocks_settings', array() );

		// Check for font loading mode change
		$font_setting_changed = false;
		$new_use_local_fonts = isset($settings['google_fonts_local']) ? (bool) $settings['google_fonts_local'] : false;
		$old_use_local_fonts = isset($current_settings['google_fonts_local']) ? (bool) $current_settings['google_fonts_local'] : false;
		
		if ($new_use_local_fonts !== $old_use_local_fonts) {
			$font_setting_changed = true;
		}

		// Validate settings.
		$validated_settings = array(
			'content_width'        => isset( $settings['content_width'] ) ? sanitize_text_field( $settings['content_width'] ) : $current_settings['content_width'],
			'content_max_width'    => isset( $settings['content_max_width'] ) ? sanitize_text_field( $settings['content_max_width'] ) : $current_settings['content_max_width'],
			'recaptcha_site_key'   => isset( $settings['recaptcha_site_key'] ) ? sanitize_text_field( $settings['recaptcha_site_key'] ) : $current_settings['recaptcha_site_key'],
			'recaptcha_secret_key' => isset( $settings['recaptcha_secret_key'] ) ? sanitize_text_field( $settings['recaptcha_secret_key'] ) : $current_settings['recaptcha_secret_key'],
			'google_maps_api_key'  => isset( $settings['google_maps_api_key'] ) ? sanitize_text_field( $settings['google_maps_api_key'] ) : $current_settings['google_maps_api_key'],
			'google_maps_map_id'   => isset( $settings['google_maps_map_id'] ) ? sanitize_text_field( $settings['google_maps_map_id'] ) : $current_settings['google_maps_map_id'],
			'google_fonts_local'   => $new_use_local_fonts,
			'enable_schema_markup' => isset( $settings['enable_schema_markup'] ) ? (bool) $settings['enable_schema_markup'] : $current_settings['enable_schema_markup'],
			
			// Newsletter settings
			'newsletter_platform'  => isset( $settings['newsletter_platform'] ) ? sanitize_text_field( $settings['newsletter_platform'] ) : ( isset( $current_settings['newsletter_platform'] ) ? $current_settings['newsletter_platform'] : '' ),
			
			// MailChimp
			'mailchimp_api_key'       => isset( $settings['mailchimp_api_key'] ) ? sanitize_text_field( $settings['mailchimp_api_key'] ) : ( isset( $current_settings['mailchimp_api_key'] ) ? $current_settings['mailchimp_api_key'] : '' ),
			'mailchimp_audience_id'   => isset( $settings['mailchimp_audience_id'] ) ? sanitize_text_field( $settings['mailchimp_audience_id'] ) : ( isset( $current_settings['mailchimp_audience_id'] ) ? $current_settings['mailchimp_audience_id'] : '' ),
			'mailchimp_tags'          => isset( $settings['mailchimp_tags'] ) ? sanitize_text_field( $settings['mailchimp_tags'] ) : ( isset( $current_settings['mailchimp_tags'] ) ? $current_settings['mailchimp_tags'] : '' ),
			'mailchimp_double_optin'  => isset( $settings['mailchimp_double_optin'] ) ? (bool) $settings['mailchimp_double_optin'] : ( isset( $current_settings['mailchimp_double_optin'] ) ? $current_settings['mailchimp_double_optin'] : false ),
			
			// ActiveCampaign
			'activecampaign_api_url'  => isset( $settings['activecampaign_api_url'] ) ? esc_url_raw( $settings['activecampaign_api_url'] ) : ( isset( $current_settings['activecampaign_api_url'] ) ? $current_settings['activecampaign_api_url'] : '' ),
			'activecampaign_api_key'  => isset( $settings['activecampaign_api_key'] ) ? sanitize_text_field( $settings['activecampaign_api_key'] ) : ( isset( $current_settings['activecampaign_api_key'] ) ? $current_settings['activecampaign_api_key'] : '' ),
			'activecampaign_list_id'  => isset( $settings['activecampaign_list_id'] ) ? sanitize_text_field( $settings['activecampaign_list_id'] ) : ( isset( $current_settings['activecampaign_list_id'] ) ? $current_settings['activecampaign_list_id'] : '' ),
			'activecampaign_tags'     => isset( $settings['activecampaign_tags'] ) ? sanitize_text_field( $settings['activecampaign_tags'] ) : ( isset( $current_settings['activecampaign_tags'] ) ? $current_settings['activecampaign_tags'] : '' ),
			
			// Brevo
			'brevo_api_key'           => isset( $settings['brevo_api_key'] ) ? sanitize_text_field( $settings['brevo_api_key'] ) : ( isset( $current_settings['brevo_api_key'] ) ? $current_settings['brevo_api_key'] : '' ),
			'brevo_list_id'           => isset( $settings['brevo_list_id'] ) ? sanitize_text_field( $settings['brevo_list_id'] ) : ( isset( $current_settings['brevo_list_id'] ) ? $current_settings['brevo_list_id'] : '' ),
			
			// Klaviyo
			'klaviyo_api_key'         => isset( $settings['klaviyo_api_key'] ) ? sanitize_text_field( $settings['klaviyo_api_key'] ) : ( isset( $current_settings['klaviyo_api_key'] ) ? $current_settings['klaviyo_api_key'] : '' ),
			'klaviyo_list_id'         => isset( $settings['klaviyo_list_id'] ) ? sanitize_text_field( $settings['klaviyo_list_id'] ) : ( isset( $current_settings['klaviyo_list_id'] ) ? $current_settings['klaviyo_list_id'] : '' ),
			
			// ConvertKit
			'convertkit_api_key'      => isset( $settings['convertkit_api_key'] ) ? sanitize_text_field( $settings['convertkit_api_key'] ) : ( isset( $current_settings['convertkit_api_key'] ) ? $current_settings['convertkit_api_key'] : '' ),
			'convertkit_form_id'      => isset( $settings['convertkit_form_id'] ) ? sanitize_text_field( $settings['convertkit_form_id'] ) : ( isset( $current_settings['convertkit_form_id'] ) ? $current_settings['convertkit_form_id'] : '' ),
			'convertkit_tags'         => isset( $settings['convertkit_tags'] ) ? sanitize_text_field( $settings['convertkit_tags'] ) : ( isset( $current_settings['convertkit_tags'] ) ? $current_settings['convertkit_tags'] : '' ),
			
			// MailerLite
			'mailerlite_api_key'      => isset( $settings['mailerlite_api_key'] ) ? sanitize_text_field( $settings['mailerlite_api_key'] ) : ( isset( $current_settings['mailerlite_api_key'] ) ? $current_settings['mailerlite_api_key'] : '' ),
			'mailerlite_group_id'     => isset( $settings['mailerlite_group_id'] ) ? sanitize_text_field( $settings['mailerlite_group_id'] ) : ( isset( $current_settings['mailerlite_group_id'] ) ? $current_settings['mailerlite_group_id'] : '' ),
		);

		update_option( 'digiblocks_settings', $validated_settings );

		// Process all fonts if the font loading setting changed
		if ($font_setting_changed) {
			// Get the existing fonts manager instance
			$fonts_handler = DigiBlocks_Fonts::get_instance();
			$fonts_handler->process_all_fonts_on_setting_change($new_use_local_fonts);
		}

		return rest_ensure_response(
			array(
				'success' => true,
				'message' => __( 'Settings updated successfully.', 'digiblocks' ),
			)
		);
	}

	/**
	 * Update active blocks.
	 *
	 * @param WP_REST_Request $request Request object.
	 * @return WP_REST_Response Response object.
	 */
	public function update_active_blocks( $request ) {
		$blocks_status = $request->get_json_params();
		$inactive_blocks = array();
		
		// Find blocks that are set as inactive
		foreach ( $blocks_status as $block_name => $is_active ) {
			if ( ! $is_active ) {
				$inactive_blocks[$block_name] = true;
			}
		}
		
		// Save only the inactive blocks
		update_option( 'digiblocks_inactive_blocks', $inactive_blocks );

		return rest_ensure_response(
			array(
				'success' => true,
				'message' => __( 'Block settings updated successfully.', 'digiblocks' ),
			)
		);
	}

	/**
	 * Get active status for a block
	 *
	 * @param string $block_name Block name
	 * @return bool Whether the block is active
	 */
	public function get_block_active_status( $block_name ) {
		// Get list of inactive blocks
		$inactive_blocks = get_option('digiblocks_inactive_blocks', array());
		
		// If block is in the inactive list, it's not active
		if (isset($inactive_blocks[$block_name]) && $inactive_blocks[$block_name] === true) {
			return false;
		}
		
		// By default, all blocks are active if not explicitly deactivated
		return true;
	}

	/**
	 * Regenerate all DigiBlocks assets including builder elements.
	 *
	 * @param WP_REST_Request $request Request object.
	 * @return WP_REST_Response Response object.
	 */
	public function regenerate_all_assets( $request ) {
		// Increase execution time for large sites
		set_time_limit( 300 );

		$regenerated = array(
			'posts' => 0,
			'builders' => 0,
			'css_files' => 0,
			'js_files' => 0,
			'font_files' => 0,
			'errors' => array(),
		);

		try {
			// Get all public post types
			$post_types = get_post_types( array( 'public' => true ) );
			
			// Add DigiStore Builder post type if it exists
			if ( post_type_exists( 'digi_builder' ) ) {
				$post_types[] = 'digi_builder';
			}
			
			// Get all posts that might contain blocks
			$posts = get_posts( array(
				'post_type'      => $post_types,
				'post_status'    => array( 'publish', 'private', 'draft' ),
				'posts_per_page' => -1,
				'suppress_filters' => false,
			) );

			// Process each post
			foreach ( $posts as $post ) {
				try {
					// Skip if post type doesn't support block editor (except for digi_builder)
					if ( $post->post_type !== 'digi_builder' && ! use_block_editor_for_post_type( $post->post_type ) ) {
						continue;
					}

					$content = $post->post_content;

					// Check if content has any DigiBlocks blocks
					if ( false === strpos( $content, '<!-- wp:digiblocks/' ) ) {
						// Clean up existing files for posts without DigiBlocks
						$this->cleanup_block_assets( $post->ID );
						continue;
					}

					// Use the existing generate_block_assets method which already works
					$this->generate_block_assets( $post->ID, $post );

					// Check if files were actually created
					$css_file = DIGIBLOCKS_ASSETS_DIR . '/digiblocks-' . $post->ID . '.css';
					$js_file  = DIGIBLOCKS_ASSETS_DIR . '/digiblocks-' . $post->ID . '.js';

					if ( file_exists( $css_file ) ) {
						$regenerated['css_files']++;
					}

					if ( file_exists( $js_file ) ) {
						$regenerated['js_files']++;
					}

					// Process fonts if the fonts manager exists
					if ( class_exists( 'DigiBlocks_Fonts' ) ) {
						$fonts_handler = DigiBlocks_Fonts::get_instance();
						$fonts_handler->process_post_fonts( $post->ID, $post, true );
						$regenerated['font_files']++;
					}

					// Track if this was a builder or regular post
					if ( $post->post_type === 'digi_builder' ) {
						$regenerated['builders']++;
					} else {
						$regenerated['posts']++;
					}

				} catch ( Exception $e ) {
					$regenerated['errors'][] = sprintf(
						'Error processing %s ID %d (%s): %s',
						$post->post_type === 'digi_builder' ? 'builder' : 'post',
						$post->ID,
						$post->post_title,
						$e->getMessage()
					);
				} catch ( Error $e ) {
					$regenerated['errors'][] = sprintf(
						'Fatal error processing %s ID %d (%s): %s',
						$post->post_type === 'digi_builder' ? 'builder' : 'post',
						$post->ID,
						$post->post_title,
						$e->getMessage()
					);
				}
			}

			// Clean up orphaned files
			$this->cleanup_orphaned_assets();

			// Clear builder cache if DigiStore Builder exists
			if ( class_exists( 'DigiStore_Builder' ) ) {
				$this->clear_digistore_builder_cache();
			}

			// Regenerate all fonts if local fonts are enabled
			$settings = get_option( 'digiblocks_settings', array() );
			$use_local_fonts = isset( $settings['google_fonts_local'] ) ? $settings['google_fonts_local'] : false;
			
			if ( $use_local_fonts && class_exists( 'DigiBlocks_Fonts' ) ) {
				try {
					$fonts_handler = DigiBlocks_Fonts::get_instance();
					$fonts_handler->process_all_fonts_on_setting_change( true );
				} catch ( Exception $e ) {
					$regenerated['errors'][] = 'Error processing fonts: ' . $e->getMessage();
				}
			}

			// Create success message
			$message_parts = array();
			if ( $regenerated['posts'] > 0 ) {
				$message_parts[] = sprintf( '%d posts', $regenerated['posts'] );
			}
			if ( $regenerated['builders'] > 0 ) {
				$message_parts[] = sprintf( '%d builders', $regenerated['builders'] );
			}
			
			$processed_items = ! empty( $message_parts ) ? implode( ' and ', $message_parts ) : '0 items';

			return rest_ensure_response( array(
				'success' => true,
				'message' => sprintf(
					__( 'Successfully regenerated assets for %s. Created %d CSS files, %d JS files, and processed %d font files.', 'digiblocks' ),
					$processed_items,
					$regenerated['css_files'],
					$regenerated['js_files'],
					$regenerated['font_files']
				),
				'details' => $regenerated,
			) );

		} catch ( Exception $e ) {
			return rest_ensure_response( array(
				'success' => false,
				'message' => sprintf(
					__( 'Error regenerating assets: %s', 'digiblocks' ),
					$e->getMessage()
				),
			) );
		} catch ( Error $e ) {
			return rest_ensure_response( array(
				'success' => false,
				'message' => sprintf(
					__( 'Fatal error regenerating assets: %s', 'digiblocks' ),
					$e->getMessage()
				),
			) );
		}
	}

	/**
	 * Clear DigiStore Builder cache after regeneration
	 */
	private function clear_digistore_builder_cache() {
		// Clear the builder cache so the new assets are loaded
		global $wpdb;
		
		// Delete all DigiStore builder transients
		$wpdb->query(
			$wpdb->prepare(
				"DELETE FROM $wpdb->options WHERE option_name LIKE %s",
				'_transient_digistore_builders_%'
			)
		);
		
		// Also delete the timeout entries
		$wpdb->query(
			$wpdb->prepare(
				"DELETE FROM $wpdb->options WHERE option_name LIKE %s",
				'_transient_timeout_digistore_builders_%'
			)
		);
	}

	/**
	 * Enhanced cleanup_orphaned_assets to include builder files
	 */
	private function cleanup_orphaned_assets() {
		if ( ! file_exists( DIGIBLOCKS_ASSETS_DIR ) ) {
			return;
		}

		// Get all existing posts including builders
		$post_types = get_post_types( array( 'public' => true ) );
		
		// Add DigiStore Builder post type if it exists
		if ( post_type_exists( 'digi_builder' ) ) {
			$post_types[] = 'digi_builder';
		}

		$existing_posts = get_posts( array(
			'post_type'      => $post_types,
			'post_status'    => array( 'publish', 'private', 'draft', 'future', 'pending' ),
			'posts_per_page' => -1,
			'fields'         => 'ids',
		) );

		$existing_post_ids = array_flip( $existing_posts );

		// Get all files in the assets directory
		$files = glob( DIGIBLOCKS_ASSETS_DIR . '/digiblocks-*.{css,js}', GLOB_BRACE );
		
		if ( ! $files ) {
			return;
		}

		foreach ( $files as $file ) {
			$filename = basename( $file );
			
			// Extract post ID from filename (digiblocks-{post_id}.css or digiblocks-{post_id}.js)
			if ( preg_match( '/digiblocks-(\d+)\.(css|js)$/', $filename, $matches ) ) {
				$post_id = (int) $matches[1];
				
				// Delete file if post doesn't exist
				if ( ! isset( $existing_post_ids[ $post_id ] ) ) {
					wp_delete_file( $file );
				}
			}
			
			// Handle font files (digiblocks-fonts-{post_id}.css)
			if ( preg_match( '/digiblocks-fonts-(\d+)\.css$/', $filename, $matches ) ) {
				$post_id = (int) $matches[1];
				
				// Delete file if post doesn't exist
				if ( ! isset( $existing_post_ids[ $post_id ] ) ) {
					wp_delete_file( $file );
				}
			}
		}
	}

	/**
	 * Get plugin icon.
	 *
	 * @return string SVG icon.
	 */
	private function get_plugin_icon() {
		return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="24" height="24" fill="#fff"><path d="m48.9542389 5.0452399-21.4456806 11.5626397c9.7644787 5.3564796 4.6071224 2.5277596 21.4441586 11.7617607l21.4472008-11.7617588z"/><path d="m25.1662388 45.1154823-21.4456787 11.5611191c9.5319195 5.2303162 4.5615196 2.5034409 21.4441586 11.7617607l21.3712006-11.7207184c-6.8780023-3.8136863-2.5885583-1.4774398-21.3696805-11.6021614z"/><path d="m26.2788792 94.9547577 21.5551204-11.9487152v-24.4491997l-21.5551204 11.8210411z"/><path d="m72.7376785 45.1154823c-18.8555984 10.1642342-14.6254425 7.862957-21.3712005 11.6021614 8.4952812 4.6618423 4.0827217 2.2419968 21.3696823 11.7222443l21.4472046-11.7617607z"/><path d="m71.6204758 42.9358025v-24.4492035l-21.5551186 11.8210411v24.4917603c7.0406418-3.7939225 2.7223206-1.4242402 21.5551186-11.8635979z"/><path d="m50.0714417 58.5568428v24.4491997l21.5444793 11.9487152v-24.5783997c-18.2627983-10.0198402-13.8046417-7.5741577-21.5444793-11.8195152z"/><path d="m47.8324776 54.7963562v-24.4902363c-17.3903179-9.5410404-12.936718-7.0984001-21.5444775-11.819519v24.4492016c18.6853619 10.3633613 14.3518391 7.983036 21.5444775 11.8605537z"/><path d="m73.8488007 94.9547577 21.5551147-11.9487152v-24.4491997l-21.5551147 11.8210411z"/><path d="m2.5 58.5568428v24.4491997l21.5444794 11.9487152v-24.5783997c-17.2352791-9.4574394-12.7771197-7.0102386-21.5444794-11.8195152z"/><path d="m97.3297577 55.9622002c.059288.0440788.1185608.0896759.1489639.1489601.0106354.0167236.0121613.0349579.0212784.0516815-.0075989-.0182419-.0060806-.0395241-.0151978-.0562401-.0364761-.0623207-.1018448-.0987968-.1504745-.1519966-.0775223-.0881577-.1413651-.1869621-.2447205-.247757l.0015182.0015182c.1048737.0607949.1641541.1641503.2386323.2538339z"/></svg>';
	}

	/**
	 * Check if schema markup is enabled
	 *
	 * @return bool Whether schema markup is enabled
	 */
	public function is_schema_markup_enabled() {
		$settings = get_option( 'digiblocks_settings', array() );
		return isset( $settings['enable_schema_markup'] ) ? $settings['enable_schema_markup'] : true;
	}

	/**
	 * Initialize forms handler if needed.
	 */
	public function init_forms_handler() {
		// First, check if the forms block is even active in settings
		if (!$this->get_block_active_status('forms')) {
			return;
		}

		// Check if it's an AJAX form submission
		// phpcs:ignore WordPress.Security.NonceVerification.Missing
		$is_form_submission = defined( 'DOING_AJAX' ) && DOING_AJAX && isset( $_POST['action'] ) && $_POST['action'] === 'digiblocks_submit_form';
		

		// Case 1: AJAX form submission - load the handler directly
		if ( $is_form_submission ) {
			$this->load_forms_handler();
			return;
		}

		// Case 2: Check if current page contains forms block
		global $post;
		if ( $post && has_blocks( $post->post_content ) ) {
			$blocks = parse_blocks( $post->post_content );
			if ( $this->has_forms_block( $blocks ) ) {
				$this->load_forms_handler();
			}
		}
	}

	/**
	 * Load the forms handler file if it hasn't been loaded yet.
	 */
	private function load_forms_handler() {
		static $handler_loaded = false;

		// Only load the handler once
		if ( ! $handler_loaded ) {
			$handler_file = DIGIBLOCKS_PLUGIN_DIR . 'includes/class-digiblocks-forms-handler.php';

			if ( file_exists( $handler_file ) ) {
				require_once $handler_file;
				$handler_loaded = true;
			}
		}
	}

	/**
	 * Initialize newsletter handler if needed.
	 */
	public function init_newsletter_handler() {
		// First, check if the newsletter block is even active in settings
		if (!$this->get_block_active_status('newsletter')) {
			return;
		}

		// Check if it's an AJAX newsletter submission
		// phpcs:ignore WordPress.Security.NonceVerification.Missing
		$is_newsletter_submission = defined( 'DOING_AJAX' ) && DOING_AJAX && isset( $_POST['action'] ) && $_POST['action'] === 'digiblocks_newsletter_subscribe';
		

		// Case 1: AJAX newsletter submission - load the handler directly
		if ( $is_newsletter_submission ) {
			$this->load_newsletter_handler();
			return;
		}

		// Case 2: Check if current page contains newsletter block
		global $post;
		if ( $post && has_blocks( $post->post_content ) ) {
			$blocks = parse_blocks( $post->post_content );
			if ( $this->has_newsletter_block( $blocks ) ) {
				$this->load_newsletter_handler();
			}
		}
	}

	/**
	 * Load the newsletter handler file if it hasn't been loaded yet.
	 */
	private function load_newsletter_handler() {
		static $handler_loaded = false;

		// Only load the handler once
		if ( ! $handler_loaded ) {
			$handler_file = DIGIBLOCKS_PLUGIN_DIR . 'includes/class-digiblocks-newsletter-handler.php';

			if ( file_exists( $handler_file ) ) {
				require_once $handler_file;
				$handler_loaded = true;
			}
		}
	}

	/**
	 * Initialize search handler if needed.
	 */
	public function init_search_handler() {
		// First, check if the search form block is even active in settings
		if ( ! $this->get_block_active_status( 'search-form' ) ) {
			return;
		}

		// Check if it's an AJAX search request
		$is_search_request = defined( 'DOING_AJAX' ) && DOING_AJAX && isset( $_POST['action'] ) && $_POST['action'] === 'digiblocks_ajax_search';
		
		// Case 1: AJAX search request - load the handler directly
		if ( $is_search_request ) {
			$this->load_search_handler();
			return;
		}

		// Case 2: Check if current page contains search form block
		global $post;
		if ( $post && has_blocks( $post->post_content ) ) {
			$blocks = parse_blocks( $post->post_content );
			if ( $this->has_search_form_blocks( $blocks ) ) {
				$this->load_search_handler();
			}
		}
	}

	/**
	 * Load the search handler actions if they haven't been loaded yet.
	 */
	private function load_search_handler() {
		static $handler_loaded = false;

		// Only load the handler once
		if ( ! $handler_loaded ) {
			add_action( 'wp_ajax_digiblocks_ajax_search', array( $this, 'handle_ajax_search' ) );
			add_action( 'wp_ajax_nopriv_digiblocks_ajax_search', array( $this, 'handle_ajax_search' ) );
			$handler_loaded = true;
		}
	}

	/**
	 * Get all available post types for search
	 * 
	 * @return array List of post types with labels
	 */
	public function get_searchable_post_types() {
		$post_types = get_post_types( array( 'public' => true ), 'objects' );
		$searchable_types = array();
		
		// Exclude certain post types that shouldn't be searchable
		$excluded_types = array( 'attachment', 'revision', 'nav_menu_item', 'custom_css', 'customize_changeset', 'oembed_cache', 'user_request', 'wp_block' );
		
		foreach ( $post_types as $post_type_slug => $post_type_object ) {
			if ( in_array( $post_type_slug, $excluded_types ) ) {
				continue;
			}
			
			$searchable_types[] = array(
				'label' => $post_type_object->labels->name,
				'value' => $post_type_slug,
			);
		}
		
		return $searchable_types;
	}

	/**
	 * Handle AJAX search requests
	 */
	public function handle_ajax_search() {
		// Verify nonce
		if ( ! wp_verify_nonce( $_POST['nonce'], 'digiblocks_search_nonce' ) ) {
			wp_die( __( 'Security check failed', 'digiblocks' ), 'digiblocks', array( 'response' => 403 ) );
		}

		$query = sanitize_text_field( $_POST['query'] );
		$post_type = sanitize_text_field( $_POST['post_type'] );
		$custom_post_types = isset( $_POST['custom_post_types'] ) ? sanitize_text_field( $_POST['custom_post_types'] ) : '';

		if ( empty( $query ) || strlen( $query ) < 2 ) {
			wp_send_json_error( __( 'Search query too short', 'digiblocks' ) );
		}

		// Determine post types to search
		if ( $post_type === 'all' ) {
			// Get all public searchable post types
			$all_post_types = get_post_types( array( 'public' => true ), 'names' );
			$excluded_types = array( 'attachment', 'revision', 'nav_menu_item', 'custom_css', 'customize_changeset', 'oembed_cache', 'user_request', 'wp_block' );
			$search_post_types = array_diff( $all_post_types, $excluded_types );
		} elseif ( $post_type === 'post' ) {
			$search_post_types = array( 'post' );
		} elseif ( $post_type === 'page' ) {
			$search_post_types = array( 'page' );
		} elseif ( $post_type === 'custom' && ! empty( $custom_post_types ) ) {
			$search_post_types = explode( ',', $custom_post_types );
			$search_post_types = array_map( 'trim', $search_post_types );
			$search_post_types = array_filter( $search_post_types );
		} else {
			// Single post type search (including custom post types)
			$search_post_types = array( $post_type );
		}

		// Perform search
		$args = array(
			's'                   => $query,
			'post_type'           => $search_post_types,
			'post_status'         => 'publish',
			'posts_per_page'      => 10,
			'ignore_sticky_posts' => true,
		);

		$search_query = new WP_Query( $args );
		$results = array();

		if ( $search_query->have_posts() ) {
			while ( $search_query->have_posts() ) {
				$search_query->the_post();
				
				$post_id = get_the_ID();
				$post_type_object = get_post_type_object( get_post_type() );
				
				$result = array(
					'id'        => $post_id,
					'title'     => get_the_title(),
					'url'       => get_permalink(),
					'excerpt'   => $this->get_search_excerpt( get_the_content(), $query, 120 ),
					'post_type' => $post_type_object ? $post_type_object->labels->singular_name : get_post_type(),
					'date'      => get_the_date(),
				);

				// Add featured image if available
				if ( has_post_thumbnail() ) {
					$result['image'] = get_the_post_thumbnail_url( $post_id, 'thumbnail' );
				}

				$results[] = $result;
			}
			wp_reset_postdata();
		}

		wp_send_json_success( $results );
	}

	/**
	 * Generate search excerpt with highlighted terms
	 *
	 * @param string $content The content to extract excerpt from.
	 * @param string $query The search query.
	 * @param int    $length Maximum length of excerpt.
	 * @return string The generated excerpt.
	 */
	private function get_search_excerpt( $content, $query, $length = 120 ) {
		// Strip HTML and shortcodes
		$content = wp_strip_all_tags( strip_shortcodes( $content ) );
		
		if ( empty( $content ) ) {
			return '';
		}

		// Find the position of the search term
		$query_pos = stripos( $content, $query );
		
		if ( $query_pos === false ) {
			// If query not found, return beginning of content
			return wp_trim_words( $content, 20, '...' );
		}

		// Calculate start position to center the query
		$start = max( 0, $query_pos - intval( $length / 2 ) );
		
		// Extract excerpt
		$excerpt = substr( $content, $start, $length );
		
		// Trim to word boundaries
		if ( $start > 0 ) {
			$space_pos = strpos( $excerpt, ' ' );
			if ( $space_pos !== false ) {
				$excerpt = substr( $excerpt, $space_pos + 1 );
			}
			$excerpt = '...' . $excerpt;
		}
		
		if ( strlen( $content ) > $start + $length ) {
			$last_space = strrpos( $excerpt, ' ' );
			if ( $last_space !== false ) {
				$excerpt = substr( $excerpt, 0, $last_space );
			}
			$excerpt .= '...';
		}

		return $excerpt;
	}

	/**
	 * AJAX handler to get DigiCommerce cart data
	 */
	public function ajax_get_digi_cart_data() {
		try {
			// Check if DigiCommerce is active
			if ( ! class_exists( 'DigiCommerce' ) || ! class_exists( 'DigiCommerce_Checkout' ) ) {
				wp_send_json_error( array( 'message' => __( 'DigiCommerce is not active.', 'digiblocks' ) ) );
				return;
			}

			// More lenient nonce check for cart data
			$nonce_check = check_ajax_referer( 'digiblocks_cart_nonce', 'nonce', false );
			
			// Only require nonce verification for logged-in users
			if ( is_user_logged_in() && ! $nonce_check ) {
				wp_send_json_error( array( 'message' => __( 'Security check failed', 'digiblocks' ) ) );
				return;
			}

			$checkout = DigiCommerce_Checkout::instance();
			
			// CRITICAL: Force session initialization for AJAX requests
			if ( method_exists( $checkout, 'init_session' ) ) {
				$checkout->init_session();
			}
			
			// For logged-out users, ensure we have a session
			if ( ! is_user_logged_in() ) {
				$session_key = $checkout->get_current_session_key();
				if ( empty( $session_key ) ) {
					// No session available, return empty cart
					wp_send_json_success( array(
						'count' => 0,
						'total' => '$0.00',
						'items' => array(),
					) );
					return;
				}
			}

			// Get cart items
			$cart_items = array();
			if ( method_exists( $checkout, 'get_cart_items' ) ) {
				$cart_items = $checkout->get_cart_items();
			}

			$cart_count = is_array( $cart_items ) ? count( $cart_items ) : 0;
			
			// Calculate total
			$cart_total = 0;
			if ( is_array( $cart_items ) ) {
				foreach ( $cart_items as $item ) {
					$cart_total += isset( $item['price'] ) ? (float) $item['price'] : 0;
				}
			}

			// Format total using DigiCommerce currency settings
			$formatted_total = '';
			if ( class_exists( 'DigiCommerce_Product' ) ) {
				$product_instance = DigiCommerce_Product::instance();
				$currency_symbol = $product_instance->get_currency_symbol( DigiCommerce()->get_option( 'currency', 'USD' ) );
				$currency_position = DigiCommerce()->get_option( 'currency_position', 'left' );
				
				if ( 'right' === $currency_position ) {
					$formatted_total = number_format( $cart_total, 2 ) . $currency_symbol;
				} else {
					$formatted_total = $currency_symbol . number_format( $cart_total, 2 );
				}
			} else {
				$formatted_total = '$' . number_format( $cart_total, 2 );
			}

			// Format cart items for frontend
			$formatted_items = array();
			if ( is_array( $cart_items ) ) {
				foreach ( $cart_items as $index => $item ) {
					$product_id = isset( $item['product_id'] ) ? $item['product_id'] : 0;
					$product_name = isset( $item['name'] ) ? $item['name'] : '';
					$product_price = isset( $item['price'] ) ? (float) $item['price'] : 0;
					$variation_name = isset( $item['variation_name'] ) ? $item['variation_name'] : '';
					
					// Get product featured image
					$product_image_url = '';
					if ( $product_id ) {
						$image_id = get_post_thumbnail_id( $product_id );
						if ( $image_id ) {
							$product_image_url = wp_get_attachment_image_url( $image_id, 'thumbnail' );
						}
					}
					
					// Format price using DigiCommerce settings
					$formatted_price = '';
					if ( class_exists( 'DigiCommerce_Product' ) ) {
						$product_instance = DigiCommerce_Product::instance();
						$currency_symbol = $product_instance->get_currency_symbol( DigiCommerce()->get_option( 'currency', 'USD' ) );
						$currency_position = DigiCommerce()->get_option( 'currency_position', 'left' );
						
						if ( 'right' === $currency_position ) {
							$formatted_price = number_format( $product_price, 2 ) . $currency_symbol;
						} else {
							$formatted_price = $currency_symbol . number_format( $product_price, 2 );
						}
					} else {
						$formatted_price = '$' . number_format( $product_price, 2 );
					}

					$formatted_items[] = array(
						'key'           => $index,
						'name'          => $product_name,
						'price'         => $formatted_price,
						'price_raw'     => $product_price,
						'variation_name' => $variation_name,
						'image'         => $product_image_url,
					);
				}
			}

			wp_send_json_success( array(
				'count' => $cart_count,
				'total' => $formatted_total,
				'items' => $formatted_items,
			) );

		} catch ( Exception $e ) {
			error_log( 'DigiBlocks Get Cart Data Error: ' . $e->getMessage() );
			wp_send_json_error( array( 'message' => __( 'Error retrieving cart data.', 'digiblocks' ) ) );
		}
	}

	/**
	 * AJAX handler to get DigiCommerce cart items for mini cart
	 */
	public function ajax_get_digi_cart_items() {
		// Use check_ajax_referer with die=false for cart operations
		$nonce_check = check_ajax_referer( 'digiblocks_cart_nonce', 'nonce', false );
		
		// For cart operations, we allow non-logged users but still verify the nonce when possible
		if ( ! $nonce_check && is_user_logged_in() ) {
			wp_send_json_error( array( 'message' => __( 'Security check failed', 'digiblocks' ) ) );
			return;
		}

		// Check if DigiCommerce is active
		if ( ! class_exists( 'DigiCommerce' ) ) {
			wp_send_json_error( array( 'message' => __( 'DigiCommerce is not active', 'digiblocks' ) ) );
			return;
		}

		$cart_items = array();
		$cart_count = 0;
		$cart_total = 0;

		if ( class_exists( 'DigiCommerce_Checkout' ) ) {
			$checkout_instance = DigiCommerce_Checkout::instance();
			$raw_cart_items = $checkout_instance->get_cart_items();
			$cart_count = count( $raw_cart_items );
			
			// Process cart items for frontend display
			foreach ( $raw_cart_items as $index => $cart_item ) {
				$product_id = isset( $cart_item['product_id'] ) ? $cart_item['product_id'] : 0;
				$product_name = isset( $cart_item['name'] ) ? $cart_item['name'] : '';
				$product_price = isset( $cart_item['price'] ) ? (float) $cart_item['price'] : 0;
				$variation_name = isset( $cart_item['variation_name'] ) && ! empty( $cart_item['variation_name'] ) ? $cart_item['variation_name'] : '';
				
				// Get product featured image
				$product_image_url = '';
				if ( $product_id ) {
					$image_id = get_post_thumbnail_id( $product_id );
					if ( $image_id ) {
						$product_image_url = wp_get_attachment_image_url( $image_id, 'thumbnail' );
					}
				}
				
				// Format price using DigiCommerce settings
				$formatted_price = '';
				if ( class_exists( 'DigiCommerce_Product' ) ) {
					$product_instance = DigiCommerce_Product::instance();
					$currency_symbol = $product_instance->get_currency_symbol( DigiCommerce()->get_option( 'currency', 'USD' ) );
					$currency_position = DigiCommerce()->get_option( 'currency_position', 'left' );
					
					if ( 'right' === $currency_position ) {
						$formatted_price = number_format( $product_price, 2 ) . $currency_symbol;
					} else {
						$formatted_price = $currency_symbol . number_format( $product_price, 2 );
					}
				} else {
					$formatted_price = '$' . number_format( $product_price, 2 );
				}
				
				$cart_items[] = array(
					'key' => $index,
					'product_id' => $product_id,
					'name' => $product_name,
					'price' => $formatted_price,
					'price_raw' => $product_price,
					'variation_name' => $variation_name,
					'image' => $product_image_url,
				);
				
				$cart_total += $product_price;
			}
		}

		// Format cart total
		$formatted_total = '';
		if ( class_exists( 'DigiCommerce_Product' ) ) {
			$product_instance = DigiCommerce_Product::instance();
			$currency_symbol = $product_instance->get_currency_symbol( DigiCommerce()->get_option( 'currency', 'USD' ) );
			$currency_position = DigiCommerce()->get_option( 'currency_position', 'left' );
			
			if ( 'right' === $currency_position ) {
				$formatted_total = number_format( $cart_total, 2 ) . $currency_symbol;
			} else {
				$formatted_total = $currency_symbol . number_format( $cart_total, 2 );
			}
		} else {
			$formatted_total = '$' . number_format( $cart_total, 2 );
		}

		wp_send_json_success( array(
			'items' => $cart_items,
			'count' => $cart_count,
			'total' => $formatted_total,
		) );
	}

	/**
	 * AJAX handler to get cart data
	 */
	public function ajax_get_cart_data() {
		// Use check_ajax_referer with die=false for cart operations
		$nonce_check = check_ajax_referer( 'digiblocks_cart_nonce', 'nonce', false );
		
		// For cart operations, we allow non-logged users but still verify the nonce when possible
		if ( ! $nonce_check && is_user_logged_in() ) {
			wp_send_json_error( array( 'message' => __( 'Security check failed', 'digiblocks' ) ) );
			return;
		}

		// Check if WooCommerce is active
		if ( ! class_exists( 'WooCommerce' ) ) {
			wp_send_json_error( array( 'message' => __( 'WooCommerce is not active', 'digiblocks' ) ) );
			return;
		}

		// Ensure WooCommerce and cart are initialized
		if ( ! WC() || is_null( WC()->cart ) ) {
			if ( function_exists( 'wc_load_cart' ) ) {
				wc_load_cart();
			}
		}

		$cart_count = WC()->cart ? WC()->cart->get_cart_contents_count() : 0;
		
		// Get clean cart total without HTML tags and entities
		$cart_total_html = WC()->cart ? WC()->cart->get_cart_total() : wc_price( 0 );
		$cart_total_clean = html_entity_decode( strip_tags( $cart_total_html ), ENT_QUOTES, 'UTF-8' );

		wp_send_json_success( array(
			'count' => $cart_count,
			'total' => $cart_total_clean,
			'total_html' => $cart_total_html,
		) );
	}

	/**
	 * AJAX handler to get cart items for mini cart
	 */
	public function ajax_get_cart_items() {
		// Use check_ajax_referer with die=false for cart operations
		$nonce_check = check_ajax_referer( 'digiblocks_cart_nonce', 'nonce', false );
		
		// For cart operations, we allow non-logged users but still verify the nonce when possible
		if ( ! $nonce_check && is_user_logged_in() ) {
			wp_send_json_error( array( 'message' => __( 'Security check failed', 'digiblocks' ) ) );
			return;
		}

		// Check if WooCommerce is active
		if ( ! class_exists( 'WooCommerce' ) ) {
			wp_send_json_error( array( 'message' => __( 'WooCommerce is not active', 'digiblocks' ) ) );
			return;
		}

		// Ensure WooCommerce and cart are initialized
		if ( ! WC() || is_null( WC()->cart ) ) {
			if ( function_exists( 'wc_load_cart' ) ) {
				wc_load_cart();
			}
		}

		$cart_items = array();

		if ( WC()->cart && ! WC()->cart->is_empty() ) {
			foreach ( WC()->cart->get_cart() as $cart_item_key => $cart_item ) {
				$product = $cart_item['data'];
				$product_id = $cart_item['product_id'];
				$quantity = $cart_item['quantity'];
				
				if ( ! $product || ! $product->exists() ) {
					continue;
				}
				
				$product_name = $product->get_name();
				
				// Get clean price without HTML tags and entities
				$product_price_html = WC()->cart->get_product_price( $product );
				$product_price_clean = html_entity_decode( strip_tags( $product_price_html ), ENT_QUOTES, 'UTF-8' );
				
				$product_image_id = $product->get_image_id();
				$product_image_url = $product_image_id ? wp_get_attachment_image_url( $product_image_id, 'thumbnail' ) : '';
				$product_permalink = $product->is_visible() ? $product->get_permalink( $cart_item ) : '';
				
				$cart_items[] = array(
					'key' => $cart_item_key,
					'name' => $product_name,
					'price' => $product_price_clean,
					'price_html' => $product_price_html,
					'quantity' => $quantity,
					'image' => $product_image_url,
					'permalink' => $product_permalink,
				);
			}
		}

		// Get clean cart total
		$cart_total_html = WC()->cart ? WC()->cart->get_cart_total() : wc_price( 0 );
		$cart_total_clean = html_entity_decode( strip_tags( $cart_total_html ), ENT_QUOTES, 'UTF-8' );

		wp_send_json_success( array(
			'items' => $cart_items,
			'count' => WC()->cart ? WC()->cart->get_cart_contents_count() : 0,
			'total' => $cart_total_clean,
			'total_html' => $cart_total_html,
		) );
	}

	/**
	 * AJAX handler to update cart item quantity
	 */
	public function ajax_update_cart_item() {
		// Use check_ajax_referer with die=false for cart operations
		$nonce_check = check_ajax_referer( 'digiblocks_cart_nonce', 'nonce', false );
		
		// For cart operations, we allow non-logged users but still verify the nonce when possible
		if ( ! $nonce_check && is_user_logged_in() ) {
			wp_send_json_error( array( 'message' => __( 'Security check failed', 'digiblocks' ) ) );
			return;
		}

		// Check if WooCommerce is active
		if ( ! class_exists( 'WooCommerce' ) ) {
			wp_send_json_error( array( 'message' => __( 'WooCommerce is not active', 'digiblocks' ) ) );
			return;
		}

		// Ensure WooCommerce and cart are initialized
		if ( ! WC() || is_null( WC()->cart ) ) {
			if ( function_exists( 'wc_load_cart' ) ) {
				wc_load_cart();
			}
		}

		$cart_item_key = sanitize_text_field( $_POST['cart_item_key'] );
		$quantity = intval( $_POST['quantity'] );

		if ( empty( $cart_item_key ) ) {
			wp_send_json_error( array( 'message' => __( 'Invalid cart item', 'digiblocks' ) ) );
			return;
		}

		if ( ! WC()->cart ) {
			wp_send_json_error( array( 'message' => __( 'Cart not available', 'digiblocks' ) ) );
			return;
		}

		// Update cart item quantity
		if ( $quantity <= 0 ) {
			WC()->cart->remove_cart_item( $cart_item_key );
		} else {
			WC()->cart->set_quantity( $cart_item_key, $quantity );
		}

		// Get clean cart total
		$cart_total_html = WC()->cart->get_cart_total();
		$cart_total_clean = html_entity_decode( strip_tags( $cart_total_html ), ENT_QUOTES, 'UTF-8' );

		wp_send_json_success( array(
			'message' => __( 'Cart updated', 'digiblocks' ),
			'count' => WC()->cart->get_cart_contents_count(),
			'total' => $cart_total_clean,
			'total_html' => $cart_total_html,
		) );
	}

	/**
	 * AJAX handler to remove cart item
	 */
	public function ajax_remove_cart_item() {
		// Use check_ajax_referer with die=false for cart operations
		$nonce_check = check_ajax_referer( 'digiblocks_cart_nonce', 'nonce', false );
		
		// For cart operations, we allow non-logged users but still verify the nonce when possible
		if ( ! $nonce_check && is_user_logged_in() ) {
			wp_send_json_error( array( 'message' => __( 'Security check failed', 'digiblocks' ) ) );
			return;
		}

		// Check if WooCommerce is active
		if ( ! class_exists( 'WooCommerce' ) ) {
			wp_send_json_error( array( 'message' => __( 'WooCommerce is not active', 'digiblocks' ) ) );
			return;
		}

		// Ensure WooCommerce and cart are initialized
		if ( ! WC() || is_null( WC()->cart ) ) {
			if ( function_exists( 'wc_load_cart' ) ) {
				wc_load_cart();
			}
		}

		$cart_item_key = sanitize_text_field( $_POST['cart_item_key'] );

		if ( empty( $cart_item_key ) ) {
			wp_send_json_error( array( 'message' => __( 'Invalid cart item', 'digiblocks' ) ) );
			return;
		}

		if ( ! WC()->cart ) {
			wp_send_json_error( array( 'message' => __( 'Cart not available', 'digiblocks' ) ) );
			return;
		}

		// Remove cart item
		WC()->cart->remove_cart_item( $cart_item_key );

		// Get clean cart total
		$cart_total_html = WC()->cart->get_cart_total();
		$cart_total_clean = html_entity_decode( strip_tags( $cart_total_html ), ENT_QUOTES, 'UTF-8' );

		wp_send_json_success( array(
			'message' => __( 'Item removed from cart', 'digiblocks' ),
			'count' => WC()->cart->get_cart_contents_count(),
			'total' => $cart_total_clean,
			'total_html' => $cart_total_html,
		) );
	}

	/**
	 * AJAX Add to Cart Handler
	 */
	public function ajax_add_to_cart() {
		// Verify nonce
		if ( ! wp_verify_nonce( $_POST['nonce'], 'digiblocks_add_to_cart' ) ) {
			wp_send_json_error( array( 'message' => __( 'Security check failed.', 'digiblocks' ) ) );
		}

		// Check if WooCommerce is active
		if ( ! class_exists( 'WooCommerce' ) ) {
			wp_send_json_error( array( 'message' => __( 'WooCommerce is not active.', 'digiblocks' ) ) );
		}

		$product_id = absint( $_POST['product_id'] );
		$quantity = isset( $_POST['quantity'] ) ? absint( $_POST['quantity'] ) : 1;

		if ( $product_id <= 0 ) {
			wp_send_json_error( array( 'message' => __( 'Invalid product.', 'digiblocks' ) ) );
		}

		$product = wc_get_product( $product_id );

		if ( ! $product ) {
			wp_send_json_error( array( 'message' => __( 'Product not found.', 'digiblocks' ) ) );
		}

		// Initialize variables for variations
		$variation_id = 0;
		$variation = array();

		// Handle variable products
		if ( $product->is_type( 'variable' ) || isset( $_POST['variation_id'] ) ) {
			// Get variation ID if provided
			if ( isset( $_POST['variation_id'] ) && absint( $_POST['variation_id'] ) > 0 ) {
				$variation_id = absint( $_POST['variation_id'] );
				$product = wc_get_product( $variation_id );
				
				if ( ! $product ) {
					wp_send_json_error( array( 'message' => __( 'Product variation not found.', 'digiblocks' ) ) );
				}
			}

			// Get variation attributes
			foreach ( $_POST as $key => $value ) {
				if ( strpos( $key, 'attribute_' ) === 0 ) {
					$variation[ sanitize_title( $key ) ] = wc_clean( $value );
				}
			}

			// If we have a parent variable product and attributes but no variation ID
			if ( ! $variation_id && ! empty( $variation ) ) {
				$parent_product = wc_get_product( $product_id );
				if ( $parent_product && $parent_product->is_type( 'variable' ) ) {
					$data_store = WC_Data_Store::load( 'product' );
					$variation_id = $data_store->find_matching_product_variation( $parent_product, $variation );
					
					if ( $variation_id ) {
						$product = wc_get_product( $variation_id );
					}
				}
			}

			// Validate that we have a valid variation for variable products
			if ( ! $variation_id && wc_get_product( $product_id )->is_type( 'variable' ) ) {
				wp_send_json_error( array( 'message' => __( 'Please select product options.', 'digiblocks' ) ) );
			}
		}

		// Check if product is purchasable
		if ( ! $product->is_purchasable() ) {
			wp_send_json_error( array( 'message' => __( 'This product cannot be purchased.', 'digiblocks' ) ) );
		}

		// Check stock
		if ( ! $product->is_in_stock() ) {
			wp_send_json_error( array( 'message' => __( 'This product is out of stock.', 'digiblocks' ) ) );
		}

		// Check quantity
		if ( $quantity <= 0 ) {
			$quantity = 1;
		}

		// Validate quantity against stock
		if ( $product->managing_stock() ) {
			$stock_quantity = $product->get_stock_quantity();
			if ( $stock_quantity !== null && $quantity > $stock_quantity ) {
				wp_send_json_error( array( 
					'message' => sprintf( 
						__( 'Sorry, we do not have enough "%s" in stock to fulfill your order (%d available).', 'digiblocks' ), 
						$product->get_name(), 
						$stock_quantity 
					) 
				) );
			}
		}

		// Add to cart
		try {
			$cart_item_key = WC()->cart->add_to_cart(
				$variation_id ? $product_id : $product->get_id(), // Parent ID for variations
				$quantity,
				$variation_id, // Variation ID
				$variation, // Variation data
				array() // Cart item data
			);

			if ( $cart_item_key ) {
				// Force cart calculation
				WC()->cart->calculate_totals();

				// Get cart fragments for updating UI
				ob_start();
				woocommerce_mini_cart();
				$mini_cart = ob_get_clean();

				// Build fragments array
				$fragments = array(
					'div.widget_shopping_cart_content' => '<div class="widget_shopping_cart_content">' . $mini_cart . '</div>',
					'.cart-contents-count' => WC()->cart->get_cart_contents_count(),
					'.cart-total' => WC()->cart->get_cart_subtotal(),
				);

				// Apply WooCommerce filters for theme compatibility
				$fragments = apply_filters( 'woocommerce_add_to_cart_fragments', $fragments );

				// Get updated cart data
				$cart_count = WC()->cart->get_cart_contents_count();
				$cart_total = WC()->cart->get_cart_total();
				$cart_hash = WC()->cart->get_cart_hash();

				// Trigger action for other plugins
				do_action( 'woocommerce_ajax_added_to_cart', $product->get_id() );

				// Send success response
				wp_send_json_success( array(
					'message' => sprintf( 
						/* translators: %s: product name */
						__( '"%s" has been added to your cart.', 'digiblocks' ), 
						$product->get_name() 
					),
					'fragments' => $fragments,
					'cart_hash' => $cart_hash,
					'cart_count' => $cart_count,
					'cart_total' => $cart_total,
					'product_id' => $product->get_id(),
					'variation_id' => $variation_id,
				) );

			} else {
				// Check for cart errors
				$notices = wc_get_notices( 'error' );
				if ( ! empty( $notices ) ) {
					$error_message = $notices[0]['notice'];
					wc_clear_notices();
					wp_send_json_error( array( 'message' => $error_message ) );
				} else {
					wp_send_json_error( array( 'message' => __( 'Could not add product to cart.', 'digiblocks' ) ) );
				}
			}

		} catch ( Exception $e ) {
			wp_send_json_error( array( 'message' => $e->getMessage() ) );
		}
	}

	/**
	 * AJAX handler for DigiCommerce add to cart
	 */
	public function ajax_digi_add_to_cart() {
		try {
			// Check if DigiCommerce is active first
			if ( ! class_exists( 'DigiCommerce' ) ) {
				wp_send_json_error( array( 'message' => __( 'DigiCommerce is not active.', 'digiblocks' ) ) );
				return;
			}

			// Get DigiCommerce checkout instance
			if ( ! class_exists( 'DigiCommerce_Checkout' ) ) {
				wp_send_json_error( array( 'message' => __( 'DigiCommerce checkout not available.', 'digiblocks' ) ) );
				return;
			}

			// More lenient nonce check - only require for logged-in users
			$nonce_check = check_ajax_referer( 'digiblocks_digi_add_to_cart', 'nonce', false );
			
			// Only require nonce verification for logged-in users
			if ( is_user_logged_in() && ! $nonce_check ) {
				wp_send_json_error( array( 'message' => __( 'Security check failed', 'digiblocks' ) ) );
				return;
			}

			// CRITICAL: Initialize checkout and session BEFORE any cart operations
			$checkout = DigiCommerce_Checkout::instance();
			
			// Force session initialization for AJAX requests - especially important for logged-out users
			if ( method_exists( $checkout, 'init_session' ) ) {
				$checkout->init_session();
			}

			// Get product ID
			$product_id = isset( $_POST['product_id'] ) ? intval( $_POST['product_id'] ) : 0;
			
			if ( ! $product_id ) {
				wp_send_json_error( array( 'message' => __( 'Invalid product ID.', 'digiblocks' ) ) );
				return;
			}

			// Verify product exists and is a DigiCommerce product
			$product = get_post( $product_id );
			if ( ! $product || 'digi_product' !== $product->post_type ) {
				wp_send_json_error( array( 'message' => __( 'Invalid product.', 'digiblocks' ) ) );
				return;
			}

			// Get variation data if provided
			$variation_name = isset( $_POST['variation_name'] ) ? sanitize_text_field( $_POST['variation_name'] ) : '';
			$variation_price = isset( $_POST['variation_price'] ) ? floatval( $_POST['variation_price'] ) : 0;
			$product_price = isset( $_POST['product_price'] ) ? floatval( $_POST['product_price'] ) : 0;

			// Determine the price to use
			$price = 0;
			if ( $variation_price > 0 ) {
				$price = $variation_price;
			} elseif ( $product_price > 0 ) {
				$price = $product_price;
			} else {
				// Fallback to product meta
				$single_price = floatval( get_post_meta( $product_id, 'digi_price', true ) );
				$sale_price = floatval( get_post_meta( $product_id, 'digi_sale_price', true ) );
				$price = ( $sale_price && $sale_price < $single_price ) ? $sale_price : $single_price;
			}

			if ( $price <= 0 ) {
				wp_send_json_error( array( 'message' => __( 'Invalid product price.', 'digiblocks' ) ) );
				return;
			}

			// Get current session key
			$session_key = $checkout->get_current_session_key();
			
			if ( empty( $session_key ) ) {
				wp_send_json_error( array( 'message' => __( 'Session could not be created.', 'digiblocks' ) ) );
				return;
			}
			
			// Get or initialize session data
			$session_data = $checkout->get_session( $session_key );
			if ( ! $session_data ) {
				$session_data = array( 'cart' => array() );
				// CRITICAL: Save initial session for both logged-in and logged-out users
				$checkout->save_session( $session_key, $session_data );
			}

			// Ensure cart array exists
			if ( ! isset( $session_data['cart'] ) || ! is_array( $session_data['cart'] ) ) {
				$session_data['cart'] = array();
			}

			$cart_items = $session_data['cart'];
			$has_variations = ! empty( $variation_name );

			// Process existing cart items - remove same product if it exists
			$new_cart_items = array();
			foreach ( $cart_items as $cart_item ) {
				if ( isset( $cart_item['product_id'] ) && $cart_item['product_id'] === $product_id ) {
					if ( $has_variations ) {
						// Skip this product entirely - we'll add the new variation
						continue;
					} else {
						// For non-variation products, if it exists, don't add it again
						wp_send_json_success( array(
							'message' => __( 'Product already in cart.', 'digiblocks' ),
							'cart' => $cart_items,
						) );
						return;
					}
				}
				// Keep all other products
				$new_cart_items[] = $cart_item;
			}

			// Get subscription details if needed
			$subscription_data = array();
			if ( $has_variations ) {
				// Get variation subscription settings from price variations
				$price_variations = get_post_meta( $product_id, 'digi_price_variations', true );
				if ( ! empty( $price_variations ) ) {
					foreach ( $price_variations as $variation ) {
						if ( isset( $variation['name'] ) && $variation['name'] === $variation_name ) {
							$subscription_data = array(
								'subscription_enabled'    => ! empty( $variation['subscription_enabled'] ),
								'subscription_period'     => $variation['subscription_period'] ?? 'month',
								'subscription_free_trial' => $variation['subscription_free_trial'] ?? array(
									'duration' => 0,
									'period'   => 'days',
								),
								'subscription_signup_fee' => $variation['subscription_signup_fee'] ?? 0,
							);
							break;
						}
					}
				}
			} else {
				// Get regular product subscription settings
				$subscription_data = array(
					'subscription_enabled'    => get_post_meta( $product_id, 'digi_subscription_enabled', true ),
					'subscription_period'     => get_post_meta( $product_id, 'digi_subscription_period', true ),
					'subscription_free_trial' => get_post_meta( $product_id, 'digi_subscription_free_trial', true ),
					'subscription_signup_fee' => get_post_meta( $product_id, 'digi_subscription_signup_fee', true ),
				);
			}

			// Create new cart item
			$new_item = array(
				'product_id'     => $product_id,
				'name'           => $product->post_title,
				'price'          => $price,
				'variation_name' => $variation_name,
			);

			// Add subscription data if enabled
			if ( ! empty( $subscription_data ) && ! empty( $subscription_data['subscription_enabled'] ) ) {
				$new_item['subscription_enabled']    = $subscription_data['subscription_enabled'];
				$new_item['subscription_period']     = $subscription_data['subscription_period'];
				$new_item['subscription_free_trial'] = $subscription_data['subscription_free_trial'];
				$new_item['subscription_signup_fee'] = $subscription_data['subscription_signup_fee'];

				if ( method_exists( 'DigiCommerce', 'is_paypal_enabled' ) && DigiCommerce()->is_paypal_enabled() ) {
					$new_item['needs_paypal_plan'] = true;
				}
			}

			// Add new item to cart
			$new_cart_items[] = $new_item;

			// Update session data
			$session_data['cart'] = $new_cart_items;

			// Save to session
			$save_result = $checkout->save_session( $session_key, $session_data );
			
			if ( false === $save_result ) {
				error_log( 'DigiBlocks: Failed to save session data for session key: ' . $session_key );
				wp_send_json_error( array( 'message' => __( 'Could not save cart to session.', 'digiblocks' ) ) );
				return;
			}

			// Force session persistence for logged-out users
			if ( ! is_user_logged_in() ) {
				// Ensure session cookie is set for guest users
				if ( method_exists( $checkout, 'set_session_cookie' ) ) {
					$checkout->set_session_cookie( true, $session_key );
				}
				
				// Additional cookie forcing for AJAX responses
				$cookie_name = 'digicommerce_session_' . COOKIEHASH;
				
				// Force cookie setting for AJAX responses
				if ( ! headers_sent() ) {
					$secure = is_ssl();
					$path = COOKIEPATH ? COOKIEPATH : '/';
					$domain = COOKIE_DOMAIN;
					
					setcookie(
						$cookie_name,
						$session_key,
						array(
							'expires'  => time() + 30 * DAY_IN_SECONDS,
							'path'     => $path,
							'domain'   => $domain,
							'secure'   => $secure,
							'httponly' => true,
							'samesite' => 'Strict',
						)
					);
					
					// Also set in $_COOKIE for immediate availability
					$_COOKIE[ $cookie_name ] = $session_key;
				}
			}

			// Update the checkout instance's cart_items property
			if ( method_exists( $checkout, 'get_cart_items' ) ) {
				// Force refresh of cart items
				$reflection = new ReflectionClass( $checkout );
				$cart_property = $reflection->getProperty( 'cart_items' );
				$cart_property->setAccessible( true );
				$cart_property->setValue( $checkout, $new_cart_items );
			}

			// Determine appropriate success message
			$message = $has_variations 
				? __( 'Product variation added to cart.', 'digiblocks' )
				: __( 'Product added to cart.', 'digiblocks' );

			// Get checkout page URL
			$checkout_url = '';
			$checkout_page_id = '';
			if ( method_exists( 'DigiCommerce', 'get_option' ) ) {
				$checkout_page_id = DigiCommerce()->get_option( 'checkout_page_id', '' );
			}
			if ( $checkout_page_id ) {
				$checkout_url = get_permalink( $checkout_page_id );
			}

			wp_send_json_success( array(
				'message'  => $message,
				'cart'     => $new_cart_items,
				'redirect' => $checkout_url,
			) );

		} catch ( Exception $e ) {
			error_log( 'DigiBlocks Add to Cart Error: ' . $e->getMessage() );
			wp_send_json_error( array(
				'message' => __( 'An error occurred while adding the product to cart.', 'digiblocks' ),
			) );
		}
	}
}